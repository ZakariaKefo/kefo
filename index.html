<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#2196f3" id="theme-color" />
  <title>ŸÖŸÜÿµÿ© ÿßŸÑÿÆÿØŸÖÿßÿ™ - KeFo Posts</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;600&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#ffffff;--fg:#000;--card-bg:#f9f9f9;--header-bg:#2196f3;--primary:#2196f3;--secondary:#0d47a1;--muted:#666;
      --radius:12px;--shadow:0 8px 25px rgba(0,0,0,.08);--transition:.3s;--font:'Cairo',sans-serif;
      --danger:#c62828;--love:#e91e63;--chip:#eef3ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:var(--font);transition:var(--transition);min-height:100vh;font-size:clamp(14px,1.8vw,16px)}
    .dark{--bg:#0f1218;--fg:#e5e5e5;--card-bg:#1f2430;--header-bg:#1f2a50;--primary:#4f8cff;--secondary:#223a7a;--muted:#999;--danger:#ef5350;--love:#ff5c93;--chip:#1f2a50}
    .pink{--bg:#ffe6f0;--fg:#880e4f;--card-bg:#ffe6f0;--header-bg:#ad1457;--primary:#d81b60;--secondary:#880e4f;--muted:#aa6688;--danger:#c2185b;--love:#ff2f7a}
    a{color:var(--primary);text-decoration:none}

    html, body { width: 100%; overflow-x: hidden; }
    html { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
    img, video { max-width: 100%; height: auto; }
    .post, .ad-slider-wrapper, .header, .bottom-nav, .modal { max-width: 100vw; }
    .post p, .ad-name { overflow-wrap: anywhere; word-break: break-word; }

    /* Header */
    .header{position:fixed;inset-inline:0;top:0;display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:10px;background:var(--header-bg);color:#fff;z-index:60}
    #searchBar{flex:1;padding:10px;border-radius:8px;border:none;min-width:160px;font-size:1rem}
    .header-right{margin-inline-start:auto;display:flex;gap:8px}
    .install-btn{display:none;align-items:center;gap:6px;background:#fff;color:#000;border:none;border-radius:999px;padding:6px 10px;cursor:pointer;font-weight:700}

    /* Chips */
    .filters{position:sticky;top:58px;z-index:55;background:transparent;padding:8px 0;margin:0 auto;max-width:1280px}
    .chips{display:flex;gap:8px;overflow:auto;padding:8px 10px}
    .chip{padding:6px 12px;border-radius:999px;border:1px solid rgba(0,0,0,.06);background:var(--chip);color:#0d47a1;cursor:pointer;white-space:nowrap;opacity:.95}
    .chip.active{background:#fff;color:#000;border-color:transparent}
    body.dark .chip{color:#cfe3ff}
    body.dark .chip.active{background:#2a3350;color:#fff}
    body.pink .chip.active{background:#fff0f6;color:#880e4f}

    /* Grid */
    .content{padding:120px 10px 140px;margin:0 auto;width:100%;max-width:1280px}
    #postsContainer{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:900px){.content{padding:130px 20px 40px}#postsContainer{grid-template-columns:repeat(2,minmax(0,1fr));gap:18px}.bottom-nav{display:none}}
    @media (min-width:1400px){#postsContainer{grid-template-columns:repeat(3,minmax(0,1fr));gap:20px}}

    /* Post */
    .post{background:var(--card-bg);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow);position:relative;overflow:hidden;transition:all .4s;opacity:0;transform:translateY(10px)}
    .post.visible{opacity:1;transform:translateY(0)}
    .post-header{display:flex;align-items:center;gap:8px;margin-bottom:6px}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;color:#fff}
    .b-help{background:#00897b}.b-complaint{background:#b71c1c}.b-edu{background:#1565c0}.b-health{background:#2e7d32}.b-misc{background:#6d4c41}
    .post h4{margin:0 0 6px;font-size:clamp(16px,2vw,18px)}
    .post p{margin:8px 0;white-space:pre-wrap;line-height:1.65}

    /* KVP (ŸÖÿ¥ÿ∫ŸëŸÑ ŸÖŸàÿ≠ŸëÿØ) */
    .kvp{position:relative;border-radius:10px;overflow:hidden;background:#000;margin-top:10px;aspect-ratio:16/9}
    .kvp-viewport{position:absolute;inset:0}
    .kvp-viewport iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
    .kvp-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background-size:cover;background-position:center;transition:opacity .25s}
    .kvp-overlay::after{content:"";position:absolute;inset:0;background:linear-gradient(to top, rgba(0,0,0,.45), rgba(0,0,0,.15));}
    .kvp-bigplay{position:relative;z-index:2;width:74px;height:74px;border-radius:50%;border:none;background:rgba(255,255,255,.9);cursor:pointer;font-size:28px;display:flex;align-items:center;justify-content:center}
    .kvp-controls{position:absolute;left:0;right:0;bottom:0;display:flex;gap:8px;align-items:center;background:linear-gradient(to top, rgba(0,0,0,.6), rgba(0,0,0,.0));padding:8px}
    .kvp-btn{border:none;background:rgba(255,255,255,.15);color:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
    .kvp-time{color:#fff;font-size:12px;min-width:90px;text-align:center}
    .kvp-seek{flex:1}
    .kvp-vol{width:90px}
    .kvp-hide{opacity:0;pointer-events:none}
    .kvp-loading{position:absolute;inset:auto 8px 50%;right:8px;background:rgba(255,255,255,.85);padding:4px 8px;border-radius:6px;font-size:12px}

    /* Reactions */
    .reactions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center}
    .react-btn{border:none;background:none;cursor:pointer;display:flex;align-items:center;gap:6px;font-size:16px;padding:8px 10px;border-radius:10px;transition:.2s}
    .react-btn:hover{background:rgba(0,0,0,.05)}
    .react-btn[disabled]{opacity:.6;cursor:not-allowed}
    .react-love i{color:var(--love)} .react-dislike i{color:var(--danger)} .count{font-weight:700}

    /* Comments */
    .comments-panel{background:rgba(0,0,0,.03);padding:10px;border-radius:8px;margin-top:12px;display:none}
    .comment{padding:6px 0;border-bottom:1px solid rgba(0,0,0,.1)}
    .comment:last-child{border-bottom:none}
    .comment small{color:var(--muted);margin-inline-start:6px}
    .comments-toggle{border:none;background:none;cursor:pointer;display:flex;align-items:center;gap:6px;font-size:16px;padding:6px 8px;border-radius:8px}
    .comments-toggle:hover{background:rgba(0,0,0,.05)}
    .badge-num{display:inline-block;min-width:18px;padding:0 6px;height:18px;line-height:18px;font-size:12px;border-radius:10px;background:var(--primary);color:#fff;text-align:center}

    /* Ads */
    .ad-slider-wrapper{margin:4px 0;background:var(--card-bg);padding:10px;border-radius:10px;box-shadow:var(--shadow)}
    .ad-slider{display:flex;gap:15px;overflow-x:auto;padding-bottom:5px;scroll-behavior:smooth}
    .ad-slide{flex:0 0 140px;text-align:center}
    .ad-slide a{display:block}
    .ad-circle{width:120px;height:120px;border-radius:50%;overflow:hidden;margin:0 auto 6px;display:flex;align-items:center;justify-content:center;background:#eee}
    .ad-circle img{width:100%;height:100%;object-fit:cover}
    .ad-name{font-size:14px;margin-top:4px}
    .ad-note{background:#ffeedd;padding:10px;text-align:center;color:#333;font-weight:600;margin-top:8px;border-radius:6px}
    .full-span{grid-column:1/-1}

    /* Bottom nav */
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;display:flex;justify-content:space-around;background:var(--secondary);padding:10px 0;border-radius:25px 25px 0 0;box-shadow:0 -4px 16px rgba(0,0,0,.3);z-index:50}
    .nav-btn{text-align:center;color:#fff;font-size:12px;cursor:pointer}.nav-btn i{font-size:20px;display:block;margin-bottom:4px}

    /* Modals + Toast */
    .modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;align-items:center;justify-content:center;padding:10px;overflow:auto}
    .modal{background:var(--card-bg);border-radius:10px;width:min(520px,92vw);padding:20px;position:relative;box-shadow:var(--shadow);color:var(--fg)}
    .close-btn{position:absolute;top:8px;inset-inline-end:10px;border:none;background:none;font-size:18px;cursor:pointer;color:var(--fg)}
    .btn{padding:10px 15px;border:none;border-radius:6px;cursor:pointer;background:var(--primary);color:#fff;font-weight:600}
    .input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,.1);margin-bottom:12px;background:#fff;font-family:inherit}
    .label{font-weight:600;margin-top:5px;display:block}
    .error{background:#f8d7da;color:#842029;padding:10px;border-radius:6px;margin-bottom:12px}

    .input-row{position:relative}
    .clear-btn{position:absolute;top:50%;inset-inline-end:8px;transform:translateY(-50%);border:none;background:transparent;cursor:pointer;font-size:16px;opacity:.7}

    .toast{position:fixed;left:50%;bottom:80px;transform:translateX(-50%) translateY(20px);background:var(--header-bg);color:#fff;padding:10px 14px;border-radius:8px;box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:transform .3s,opacity .3s;z-index:200;white-space:nowrap;max-width:90%;overflow:hidden;text-overflow:ellipsis;font-size:.95rem}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

    .skeleton{background:linear-gradient(90deg, rgba(0,0,0,.06), rgba(0,0,0,.12), rgba(0,0,0,.06));background-size:200% 100%;animation:shimmer 1.2s infinite}
    @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
    .skeleton-card{height:280px;border-radius:12px}
  </style>
</head>
<body>

  <!-- Header -->
  <div class="header">
    <input id="searchBar" type="text" placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖŸÜÿ¥Ÿàÿ±...">
    <div class="header-right">
      <button id="installBtn" class="install-btn" title="ÿ™ÿ´ÿ®Ÿäÿ™ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ">üì• ÿ™ÿ´ÿ®Ÿäÿ™</button>
      <div class="nav-btn" onclick="openNewPost()"><i>‚ûï</i><div style="font-size:11px;">ŸÖŸÜÿ¥Ÿàÿ±</div></div>
      <div class="nav-btn" onclick="openSettings()"><i>‚öôÔ∏è</i><div style="font-size:11px;">ÿ•ÿπÿØÿßÿØÿßÿ™</div></div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters">
    <div id="chips" class="chips"></div>
  </div>

  <!-- Content -->
  <div class="content">
    <div id="postsContainer"></div>
  </div>

  <!-- Bottom nav -->
  <div class="bottom-nav">
    <div class="nav-btn" onclick="openNewPost()"><i>‚ûï</i>ÿ•ÿ∂ÿßŸÅÿ©</div>
    <div class="nav-btn" onclick="showToast('ŸÇÿ≥ŸÖ ÿßŸÑÿØÿ±ÿØÿ¥ÿ© ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±')"><i>üí¨</i>ÿØÿ±ÿØÿ¥ÿ©</div>
    <div class="nav-btn" onclick="showToast('ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±')"><i>üìÇ</i>ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ</div>
    <div class="nav-btn" onclick="showToast('ŸÖŸÑŸÅŸä ÿßŸÑÿ¥ÿÆÿµŸä ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±')"><i>üë§</i>ÿßŸÑŸÖŸÑŸÅ</div>
    <div class="nav-btn" onclick="openSettings()"><i>‚öôÔ∏è</i>ÿ•ÿπÿØÿßÿØÿßÿ™</div>
  </div>

  <!-- New post modal -->
  <div id="newPostModal" class="modal-backdrop">
    <div class="modal">
      <button class="close-btn" onclick="closeNewPost()">‚úñ</button>
      <h3>ŸÜÿ¥ÿ± ŸÖŸÜÿ¥Ÿàÿ± ÿ¨ÿØŸäÿØ</h3>
      <div id="postError" style="display:none;" class="error"></div>

      <label class="label">ŸÜŸàÿπ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ± *</label>
      <select id="postType" class="input">
        <option value="">ÿßÿÆÿ™ÿ± ŸÜŸàÿπ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±</option>
        <option value="ÿ≥ÿßÿπÿØŸÜŸä">ÿ≥ÿßÿπÿØŸÜŸä</option>
        <option value="ÿ¥ŸÉŸàŸâ ŸàŸÅÿ≥ÿßÿØ">ÿ¥ŸÉŸàŸâ ŸàŸÅÿ≥ÿßÿØ</option>
        <option value="ÿ™ÿπŸÑŸäŸÖ">ÿ™ÿπŸÑŸäŸÖ</option>
        <option value="ÿµÿ≠ÿ©">ÿµÿ≠ÿ©</option>
        <option value="ŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ ŸÖÿ™ŸÜŸàÿπÿ©">ŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ ŸÖÿ™ŸÜŸàÿπÿ©</option>
      </select>

      <label class="label">ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ *</label>
      <textarea id="postContent" class="input" rows="3" placeholder="ÿßŸÉÿ™ÿ® ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±..."></textarea>

      <!-- Media: Ÿàÿßÿ≠ÿØ ŸÅŸÇÿ∑ -->
      <label class="label">ÿ±ÿßÿ®ÿ∑ ÿµŸàÿ±ÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿäÿå ŸäŸèŸÑÿ∫ŸêŸä ÿ®ÿßŸÇŸä ÿßŸÑÿ±Ÿàÿßÿ®ÿ∑)</label>
      <div class="input-row">
        <input id="imageURL" type="url" class="input media-input" placeholder="https://example.com/image.jpg">
        <button class="clear-btn" type="button" onclick="clearMedia('imageURL')">‚úñ</button>
      </div>

      <label class="label">ÿ±ÿßÿ®ÿ∑ YouTube (ÿßÿÆÿ™Ÿäÿßÿ±Ÿäÿå ŸäŸèŸÑÿ∫ŸêŸä ÿ®ÿßŸÇŸä ÿßŸÑÿ±Ÿàÿßÿ®ÿ∑)</label>
      <div class="input-row">
        <input id="youtubeURL" type="url" class="input media-input" placeholder="https://www.youtube.com/watch?v=... ÿ£Ÿà youtu.be/...">
        <button class="clear-btn" type="button" onclick="clearMedia('youtubeURL')">‚úñ</button>
      </div>

      <label class="label">ÿ±ÿßÿ®ÿ∑ Facebook (ŸÅŸäÿØŸäŸà) (ÿßÿÆÿ™Ÿäÿßÿ±Ÿäÿå ŸäŸèŸÑÿ∫ŸêŸä ÿ®ÿßŸÇŸä ÿßŸÑÿ±Ÿàÿßÿ®ÿ∑)</label>
      <div class="input-row">
        <input id="facebookURL" type="url" class="input media-input" placeholder="https://www.facebook.com/.../videos/... ÿ£Ÿà watch/?v=...">
        <button class="clear-btn" type="button" onclick="clearMedia('facebookURL')">‚úñ</button>
      </div>

      <button class="btn" onclick="submitPost()">ŸÜÿ¥ÿ±</button>
    </div>
  </div>

  <!-- Settings modal -->
  <div id="settingsModal" class="modal-backdrop">
    <div class="modal">
      <button class="close-btn" onclick="closeSettings()">‚úñ</button>
      <h3>ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸàÿ∂ÿπ</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn" style="flex:1" onclick="setMode('light')">ŸÜŸáÿßÿ±Ÿä</button>
        <button class="btn" style="flex:1" onclick="setMode('dark')">ŸÑŸäŸÑŸä</button>
        <button class="btn" style="flex:1" onclick="setMode('pink')">ÿ®ŸÜÿßÿ™Ÿä</button>
      </div>
    </div>
  </div>

  <!-- Info modal -->
  <div id="infoModal" class="modal-backdrop">
    <div class="modal">
      <button class="close-btn" onclick="closeInfo()">‚úñ</button>
      <h3 id="infoTitle">ÿ™ŸÜÿ®ŸäŸá</h3>
      <div id="infoBody" style="margin-top:8px;"></div>
      <div style="text-align:end;margin-top:12px;">
        <button class="btn" onclick="closeInfo()">ÿ≠ÿ≥ŸÜŸãÿß</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- ÿ≥ŸÉÿ±ÿ®ÿ™ ÿπÿßŸÖ: ÿßŸÑŸàÿßÿ¨Ÿáÿ© + ÿßŸÑÿ´ŸäŸÖ + PWA + KVP (ÿ¢ŸÖŸÜ) -->
  <script>
    /* ===== Modals & Toast ===== */
    function openNewPost(){document.getElementById("newPostModal").style.display="flex";document.body.style.overflow="hidden";['imageURL','youtubeURL','facebookURL'].forEach(id=>document.getElementById(id).value="");document.querySelectorAll('.input-row').forEach(r=>r.style.display='');}
    function closeNewPost(){document.getElementById("newPostModal").style.display="none";document.body.style.overflow="";}
    function openSettings(){document.getElementById("settingsModal").style.display="flex";document.body.style.overflow="hidden";}
    function closeSettings(){document.getElementById("settingsModal").style.display="none";document.body.style.overflow="";}
    function showInfo(title,message){document.getElementById('infoTitle').textContent=title||'ÿ™ŸÜÿ®ŸäŸá';document.getElementById('infoBody').textContent=message||'';document.getElementById('infoModal').style.display='flex';document.body.style.overflow="hidden";}
    function closeInfo(){document.getElementById('infoModal').style.display='none';document.body.style.overflow="";}
    window.showToast=(msg)=>{const t=document.getElementById('toast');if(!t)return;t.textContent=msg;t.classList.add('show');clearTimeout(window.__toastTimer);window.__toastTimer=setTimeout(()=>t.classList.remove('show'),2500);};

    /* ===== Theme ===== */
    const themeKey="kefo_theme";
    function applyTheme(t){
      document.body.classList.remove("light","dark","pink");
      if(t==="dark")document.body.classList.add("dark");
      else if(t==="pink")document.body.classList.add("pink");
      else document.body.classList.add("light");
      localStorage.setItem(themeKey,t);
      const meta=document.getElementById('theme-color');
      const color = t==='dark' ? '#1f2a50' : (t==='pink' ? '#ad1457' : '#2196f3');
      if(meta) meta.setAttribute('content', color);
    }
    window.setMode=function(mode){applyTheme(mode);showToast(mode==='dark'?'ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÑŸäŸÑŸä':mode==='pink'?'ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿ®ŸÜÿßÿ™Ÿä':'ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÜŸáÿßÿ±Ÿä');};
    applyTheme(localStorage.getItem(themeKey)||"light");

    /* ===== Helpers ===== */
    document.addEventListener('contextmenu',e=>e.preventDefault());
    document.addEventListener('selectstart',e=>e.preventDefault());
    document.addEventListener('touchstart',function(e){window.longTouch=setTimeout(()=>e.preventDefault(),500);},{passive:false});
    document.addEventListener('touchend',()=>clearTimeout(window.longTouch));
    const mediaInputs=Array.from(document.querySelectorAll('.media-input'));
    mediaInputs.forEach(inp=>inp.addEventListener('input',()=>{const f=mediaInputs.find(i=>i.value.trim());mediaInputs.forEach(i=>{i.closest('.input-row').style.display=(!f||i===f)?'':'none';});}));
    window.clearMedia=function(id){const el=document.getElementById(id);if(!el)return;el.value="";const f=mediaInputs.find(i=>i.value.trim());mediaInputs.forEach(i=>{i.closest('.input-row').style.display=(!f||i===f)?'':'none';});};

    /* ===== PWA ===== */
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(console.error); });
    }
    let deferredPrompt=null; const installBtn=document.getElementById('installBtn');
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt=e; if (!window.matchMedia('(display-mode: standalone)').matches && !window.navigator.standalone) installBtn.style.display='inline-flex'; });
    installBtn?.addEventListener('click', async () => { if (!deferredPrompt) return; deferredPrompt.prompt(); const c = await deferredPrompt.userChoice.catch(()=>null); deferredPrompt=null; installBtn.style.display='none'; showToast(c && c.outcome==='accepted' ? 'ÿ¨ÿßÿ±Ÿä ÿ™ÿ´ÿ®Ÿäÿ™ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ‚Ä¶' : 'ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ™ÿ´ÿ®Ÿäÿ™.'); });
    window.addEventListener('appinstalled',()=>{showToast('ÿ™ŸÖ ÿ™ÿ´ÿ®Ÿäÿ™ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ‚úÖ');installBtn.style.display='none';});

    /* ====== KVP: ŸÑŸà ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ÿå ŸÜÿÆŸÑŸä Scan ÿØÿßŸÑÿ© ŸÑÿß ÿ™ÿπŸÖŸÑ ÿ®ÿØŸÑŸãÿß ŸÖŸÜ ŸÉÿ≥ÿ± ÿßŸÑÿµŸÅÿ≠ÿ© ====== */
    window.__KVP = window.__KVP || { scan: function(){} };

    ;(function(){
      try{
        const kvp = {
          items:new Map(), ytReady:false, fbReady:false, ytQueue:[], fbQueue:[],
          ensureYT(){ if (window.YT && window.YT.Player){this.ytReady=true;this.ytQueue.splice(0).forEach(fn=>fn());return;}
            if (this._ytLoading) return; this._ytLoading=true;
            const s=document.createElement('script'); s.src="https://www.youtube.com/iframe_api"; document.head.appendChild(s);
            window.onYouTubeIframeAPIReady=()=>{this.ytReady=true;this.ytQueue.splice(0).forEach(fn=>fn());}; },
          ensureFB(){ if (window.FB && window.FB.XFBML){this.fbReady=true;this.fbQueue.splice(0).forEach(fn=>fn());return;}
            if (this._fbLoading) return; this._fbLoading=true;
            const fbroot=document.createElement('div'); fbroot.id='fb-root'; document.body.appendChild(fbroot);
            const s=document.createElement('script'); s.src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v19.0"; s.async=true; s.defer=true; document.head.appendChild(s);
            window.fbAsyncInit=()=>{ this.fbReady=true;
              FB.Event.subscribe('xfbml.ready',(msg)=>{ if(msg.type==='video'){ const inst=msg.instance; const el=document.getElementById(msg.id); const host=el&&el.closest('.kvp'); const rec=host&&this.items.get(host.dataset.kvpid); if(rec && !rec.player){ rec.player=inst; this.bindFB(rec);} }});
              this.fbQueue.splice(0).forEach(fn=>fn()); }; },
          scan(){
            document.querySelectorAll('.kvp[data-ready!="1"]').forEach(el=>{
              const id=el.dataset.kvpid||('kvp-'+Math.random().toString(36).slice(2)); el.dataset.kvpid=id; el.setAttribute('data-ready','1');
              const controls=el.querySelector('.kvp-controls'), btnPlay=controls.querySelector('.kvp-btn.kvp-play'), btnFull=controls.querySelector('.kvp-btn.kvp-full');
              const rngSeek=controls.querySelector('.kvp-seek'), rngVol=controls.querySelector('.kvp-vol'), timeEl=controls.querySelector('.kvp-time');
              const bigBtn=el.querySelector('.kvp-bigplay'), overlay=el.querySelector('.kvp-overlay'), viewport=el.querySelector('.kvp-viewport');
              const rec={ el,viewport,overlay,timeEl,rngSeek,rngVol,btnPlay,btnFull,bigBtn,type:el.dataset.type,vid:el.dataset.vid,url:el.dataset.url,player:null,dur:0,timer:null,state:'paused' };
              this.items.set(id,rec);
              const toggle=()=>this.toggle(rec);
              btnPlay.addEventListener('click',toggle); bigBtn.addEventListener('click',toggle);
              rngSeek.addEventListener('input',()=>{ timeEl.textContent=fmt(rngSeek.value*rec.dur/100)+' / '+fmt(rec.dur); });
              rngSeek.addEventListener('change',()=>this.seekTo(rec,(rngSeek.value/100)*rec.dur));
              rngVol.addEventListener('input',()=>this.setVolume(rec,+rngVol.value));
              btnFull.addEventListener('click',()=>requestFull(el));
              overlay.addEventListener('click',toggle);
            });
          },
          ensure(rec,cb){
            if (rec.player) return cb&&cb();
            rec.el.querySelector('.kvp-overlay').classList.add('kvp-hide');
            rec.el.insertAdjacentHTML('beforeend','<div class="kvp-loading">Loading‚Ä¶</div>');
            if (rec.type==='yt'){
              this.ensureYT();
              const build=()=>{ const vpId=rec.viewport.id||(rec.viewport.id=rec.el.dataset.kvpid+'-vp');
                rec.player=new YT.Player(vpId,{videoId:rec.vid,playerVars:{controls:0,rel:0,modestbranding:1,iv_load_policy:3,playsinline:1},
                  events:{ onReady:()=>{rec.dur=rec.player.getDuration()||0; rec.el.querySelector('.kvp-loading')?.remove(); this.updateTimeLoop(rec); cb&&cb();},
                           onStateChange:(e)=>{ if(e.data===1){rec.state='playing';rec.btnPlay.textContent='‚è∏';}
                                                else if(e.data===2){rec.state='paused';rec.btnPlay.textContent='‚ñ∂';}
                                                else if(e.data===0){rec.state='ended';rec.btnPlay.textContent='‚ñ∂'; this.seekTo(rec,0); rec.overlay.classList.remove('kvp-hide');} } }});
              }; this.ytReady?build():this.ytQueue.push(build);
            }else if(rec.type==='fb'){
              this.ensureFB();
              const build=()=>{ const inner=document.createElement('div'); const fbId=rec.el.dataset.kvpid+'-fb';
                inner.className='fb-video'; inner.id=fbId; inner.setAttribute('data-href',rec.url); inner.setAttribute('data-allowfullscreen','true'); inner.setAttribute('data-controls','false'); inner.setAttribute('data-show-text','false');
                rec.viewport.appendChild(inner); FB.XFBML.parse(rec.viewport,()=>{ rec.el.querySelector('.kvp-loading')?.remove(); setTimeout(()=>this.updateTimeLoop(rec),800); cb&&cb(); }); };
              this.fbReady?build():this.fbQueue.push(build);
            }
          },
          toggle(rec){ if(!rec.player){ this.ensure(rec,()=>this.play(rec)); return;} if(rec.state==='playing') this.pause(rec); else this.play(rec); },
          play(rec){ rec.overlay.classList.add('kvp-hide'); rec.btnPlay.textContent='‚è∏'; if(rec.type==='yt') rec.player.playVideo(); else if(rec.type==='fb'&&rec.player?.play) rec.player.play(); rec.state='playing'; },
          pause(rec){ rec.btnPlay.textContent='‚ñ∂'; if(rec.type==='yt') rec.player.pauseVideo(); else if(rec.type==='fb'&&rec.player?.pause) rec.player.pause(); rec.state='paused'; },
          seekTo(rec,sec){ if(!rec.player)return; if(rec.type==='yt') rec.player.seekTo(sec,true); else if(rec.type==='fb'&&rec.player?.seek) rec.player.seek(sec); },
          setVolume(rec,v){ if(!rec.player)return; if(rec.type==='yt'&&rec.player.setVolume) rec.player.setVolume(v); else if(rec.type==='fb'&&rec.player.setVolume) rec.player.setVolume(v/100); },
          updateTimeLoop(rec){ clearInterval(rec.timer); rec.timer=setInterval(()=>{ try{ let cur=0,dur=rec.dur; if(rec.type==='yt'){cur=rec.player.getCurrentTime?.()||0; dur=rec.player.getDuration?.()||dur||0;} else if(rec.type==='fb'){ if(rec.player?.getCurrentPosition) cur=rec.player.getCurrentPosition(); if(rec.player?.getDuration) dur=rec.player.getDuration(); }
              rec.dur=dur||rec.dur||0; if(rec.dur>0){ rec.rngSeek.value=Math.min(100,Math.max(0,(cur/rec.dur)*100)); rec.timeEl.textContent=fmt(cur)+' / '+fmt(rec.dur);} }catch(e){} },300); },
          bindFB(rec){ try{ rec.player.subscribe('startedPlaying',()=>{rec.state='playing';rec.btnPlay.textContent='‚è∏';rec.overlay.classList.add('kvp-hide');});
                             rec.player.subscribe('paused',()=>{rec.state='paused';rec.btnPlay.textContent='‚ñ∂';});
                             rec.player.subscribe('finishedPlaying',()=>{rec.state='ended';rec.btnPlay.textContent='‚ñ∂';rec.overlay.classList.remove('kvp-hide');}); }catch(e){} }
        };
        function fmt(s){s=Math.max(0,Math.floor(s||0));const m=Math.floor(s/60),ss=(s%60).toString().padStart(2,'0');return m+':'+ss;}
        function requestFull(el){if(el.requestFullscreen)el.requestFullscreen();else if(el.webkitRequestFullscreen)el.webkitRequestFullscreen();else if(el.msRequestFullscreen)el.msRequestFullscreen();}
        window.__KVP = kvp; // ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿßŸÑŸÄ no-op ÿ•ŸÜ ŸÜÿ¨ÿ≠ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
      }catch(err){ console.error('KVP init error (non-fatal)',err); /* ŸÜÿ™ÿ±ŸÉ no-op */ }
    })();
  </script>

  <!-- ÿ≥ŸÉÿ±ÿ®ÿ™ ÿßŸÑŸÖŸàÿØŸäŸàŸÑ: Firebase + ÿßŸÑÿ®Ÿàÿ≥ÿ™ÿßÿ™ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, updateDoc, doc, serverTimestamp, getCountFromServer, increment } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA15okly94Qb9XXSMdVdhGg5D4lMqLW1Iw",
      authDomain: "kefo-posts.firebaseapp.com",
      projectId: "kefo-posts",
      storageBucket: "kefo-posts.appspot.com",
      messagingSenderId: "647282320196",
      appId: "1:647282320196:web:9991aa9db6dfec8eb72d11",
      measurementId: "G-R9ZQ566K4H"
    };

    let db;
    try { db = getFirestore(initializeApp(firebaseConfig)); }
    catch(e){ console.error('Firebase init error', e); window.showToast?.('ÿ™ÿπÿ∞Ÿëÿ± ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖÿå ÿ≥ÿ™ÿ∏Ÿáÿ± ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ ÿπŸÜÿØ ÿßŸÑÿßÿ™ÿµÿßŸÑ.'); }

    const postsContainer=document.getElementById("postsContainer");
    const chipsEl=document.getElementById("chips");
    const filterTypes=[{key:'ÿßŸÑŸÉŸÑ',label:'ÿßŸÑŸÉŸÑ'},{key:'ÿ≥ÿßÿπÿØŸÜŸä',label:'ÿ≥ÿßÿπÿØŸÜŸä'},{key:'ÿ¥ŸÉŸàŸâ ŸàŸÅÿ≥ÿßÿØ',label:'ÿ¥ŸÉŸàŸâ ŸàŸÅÿ≥ÿßÿØ'},{key:'ÿ™ÿπŸÑŸäŸÖ',label:'ÿ™ÿπŸÑŸäŸÖ'},{key:'ÿµÿ≠ÿ©',label:'ÿµÿ≠ÿ©'},{key:'ŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ ŸÖÿ™ŸÜŸàÿπÿ©',label:'ŸÖŸÜŸàŸëÿπ'}];
    let activeFilter='ÿßŸÑŸÉŸÑ', searchText='';

    function buildChips(){ chipsEl.innerHTML=''; filterTypes.forEach(t=>{const b=document.createElement('button'); b.className='chip'+(t.key===activeFilter?' active':''); b.textContent=t.label; b.onclick=()=>{activeFilter=t.key; buildChips(); updateVisibility();}; chipsEl.appendChild(b);}); }
    buildChips();

    function showSkeletons(n=6){ postsContainer.innerHTML=''; for(let i=0;i<n;i++){const sk=document.createElement('div'); sk.className='skeleton skeleton-card'; postsContainer.appendChild(sk);} }
    showSkeletons();

    function toYouTubeId(u){try{const url=new URL(u);let v=url.searchParams.get('v');if(!v){const p=url.pathname.split('/'); v=p.pop()||p.pop();}return v||null;}catch{return null;}}
    function toYouTubeThumb(u){ const id=toYouTubeId(u); return id?`https://i.ytimg.com/vi/${id}/hqdefault.jpg`:null; }
    function toFacebookVideoURL(u){ try{return new URL(u).toString();}catch{return null;} }

    function kvpYouTube(postId, ytUrl){ const id=toYouTubeId(ytUrl); if(!id) return ''; const thumb=toYouTubeThumb(ytUrl);
      return `<div class="kvp" data-type="yt" data-vid="${id}"><div class="kvp-viewport"></div><div class="kvp-overlay" style="${thumb?`background-image:url('${thumb}')`:''}"><button class="kvp-bigplay">‚ñ∂</button></div><div class="kvp-controls"><button class="kvp-btn kvp-play">‚ñ∂</button><input type="range" class="kvp-seek" min="0" max="100" value="0"><div class="kvp-time">0:00 / 0:00</div><input type="range" class="kvp-vol" min="0" max="100" value="100"><button class="kvp-btn kvp-full">‚õ∂</button></div></div>`; }
    function kvpFacebook(postId, fbUrl){ const url=toFacebookVideoURL(fbUrl); if(!url) return '';
      return `<div class="kvp" data-type="fb" data-url="${url}"><div class="kvp-viewport"></div><div class="kvp-overlay"><button class="kvp-bigplay">‚ñ∂</button></div><div class="kvp-controls"><button class="kvp-btn kvp-play">‚ñ∂</button><input type="range" class="kvp-seek" min="0" max="100" value="0"><div class="kvp-time">0:00 / 0:00</div><input type="range" class="kvp-vol" min="0" max="100" value="100"><button class="kvp-btn kvp-full">‚õ∂</button></div></div>`; }

    function renderMedia(post){
      try{
        let html="";
        if(post.imageURL) html+=`<img src="${post.imageURL}" alt="ÿµŸàÿ±ÿ©" loading="lazy">`;
        if(post.youtubeURL) html+=kvpYouTube(post.id, post.youtubeURL);
        if(post.facebookURL) html+=kvpFacebook(post.id, post.facebookURL);
        return html;
      }catch(e){
        console.error('renderMedia error', e);
        return ''; // ŸÑÿß ŸÜŸÉÿ≥ÿ± ÿßŸÑÿµŸÅÿ≠ÿ©
      }
    }

    const observer=new IntersectionObserver(entries=>{entries.forEach(e=>{if(e.isIntersecting){e.target.classList.add('visible');observer.unobserve(e.target);}})},{threshold:.1});
    function observePosts(){ document.querySelectorAll(".post").forEach(p=>observer.observe(p)); }

    let searchTimeout;
    document.getElementById("searchBar").addEventListener("input", function(){ clearTimeout(searchTimeout); searchText=this.value.toLowerCase(); searchTimeout=setTimeout(updateVisibility,250); });
    function updateVisibility(){ const posts=document.querySelectorAll(".post"); posts.forEach(p=>{const matchesType=(activeFilter==='ÿßŸÑŸÉŸÑ')||(p.dataset.type===activeFilter); const matchesText=!searchText||p.innerText.toLowerCase().includes(searchText); p.style.display=(matchesType&&matchesText)?'':'none';}); }

    const adsPool=[{name:"ÿ•ÿπŸÑÿßŸÜ 1",image:"https://www.shishastore24.de/wp-content/uploads/2023/11/Kefo-3-jpg.jpg",link:"https://example.com/1"},{name:"ÿ•ÿπŸÑÿßŸÜ 2",image:"https://www.shishastore24.de/wp-content/uploads/2023/11/Kefo-3-jpg.jpg",link:"https://example.com/2"},{name:"ÿ•ÿπŸÑÿßŸÜ 3",image:"https://via.placeholder.com/120",link:"https://example.com/3"},{name:"ÿ•ÿπŸÑÿßŸÜ 4",image:"https://via.placeholder.com/120",link:"https://example.com/4"},{name:"ÿ•ÿπŸÑÿßŸÜ 5",image:"https://via.placeholder.com/120",link:"https://example.com/5"},{name:"ÿ•ÿπŸÑÿßŸÜ 6",image:"https://via.placeholder.com/120",link:"https://example.com/6"}];
    function getRandomAds(){const copy=[...adsPool];for(let i=copy.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[copy[i],copy[j]]=[copy[j],copy[i]];}return copy.slice(0,4);}

    if (db){
      const postsQ=query(collection(db,"posts"),orderBy("timestamp","desc"));
      onSnapshot(postsQ, snap=>{
        try{
          const posts=snap.docs.map(d=>({id:d.id,...d.data()}));
          postsContainer.innerHTML = posts.length ? "" : `<div class="error">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ ÿ≠ÿßŸÑŸäÿßŸã.</div>`;
          posts.forEach((post,i)=>{
            const loves=post.loves||0, dislikes=post.dislikes||0;
            const badgeClass = post.type==="ÿ≥ÿßÿπÿØŸÜŸä" ? "b-help" : post.type==="ÿ¥ŸÉŸàŸâ ŸàŸÅÿ≥ÿßÿØ" ? "b-complaint" : post.type==="ÿ™ÿπŸÑŸäŸÖ" ? "b-edu" : post.type==="ÿµÿ≠ÿ©" ? "b-health" : "b-misc";
            const card=document.createElement('div'); card.className='post'; card.dataset.type=post.type||''; card.dataset.postId=post.id;
            card.innerHTML=`
              <div class="post-header"><span class="badge ${badgeClass}">${post.type||'ŸÖŸÜŸàŸëÿπ'}</span></div>
              <h4>${post.type||''}</h4>
              <p>${post.content||''}</p>
              ${renderMedia(post)}
              <div class="reactions">
                <button class="react-btn react-love" id="love-${post.id}" onclick="vote('${post.id}','loves', this)"><i>‚ù§Ô∏è</i><span class="count">${loves}</span></button>
                <button class="react-btn react-dislike" id="dislike-${post.id}" onclick="vote('${post.id}','dislikes', this)"><i>üëé</i><span class="count">${dislikes}</span></button>
                <button class="comments-toggle" id="toggle-${post.id}" onclick="toggleComments('${post.id}')">üí¨ ÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™ <span class="badge-num">0</span></button>
                <button class="react-btn" onclick="sharePost()">üîó ŸÖÿ¥ÿßÿ±ŸÉÿ©</button>
              </div>
              <div class="comments-panel" id="comments-wrap-${post.id}">
                <div style="margin-top:6px;"><strong>ÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™</strong></div>
                <div class="existing-comments" style="margin-top:6px;"></div>
                <div style="margin-top:8px;display:flex;gap:6px;">
                  <input id="input-comment-${post.id}" placeholder="ÿßŸÉÿ™ÿ® ÿ™ÿπŸÑŸäŸÇŸÉ..." style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,.1);">
                  <button class="btn" style="flex:0 0 auto;" onclick="submitComment('${post.id}')">ÿ£ÿ∂ŸÅ</button>
                </div>
              </div>`;
            postsContainer.appendChild(card);

            // ‚ú® ÿ¢ŸÖŸÜÿ©: ÿ≠ÿ™Ÿâ ŸÑŸà __KVP ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©ÿå ŸÖÿß ŸÜŸÉÿ≥ÿ± ÿßŸÑÿµŸÅÿ≠ÿ©
            try { window.__KVP && window.__KVP.scan && window.__KVP.scan(); } catch(e){ console.warn('KVP scan error (non-fatal)', e); }

            if((i+1)%5===0){
              const wrapper=document.createElement('div'); wrapper.className='ad-slider-wrapper full-span';
              const slider=document.createElement('div'); slider.className='ad-slider';
              getRandomAds().forEach(ad=>{ const slide=document.createElement('div'); slide.className='ad-slide';
                slide.innerHTML=`<a href="${ad.link}" target="_blank" rel="noopener"><div class="ad-circle"><img src="${ad.image}" alt="${ad.name}" loading="lazy"></div><div class="ad-name">${ad.name}</div></a>`;
                slider.appendChild(slide);
              });
              const note=document.createElement('div'); note.className='ad-note'; note.innerHTML=`ŸÑÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿπŸÑÿßŸÜŸÉ ÿßŸÑÿÆÿßÿµ <a href="https://wa.me/123456789" target="_blank" rel="noopener">ÿßÿ∂ÿ∫ÿ∑ ŸáŸÜÿß</a>`;
              wrapper.appendChild(slider); wrapper.appendChild(note); postsContainer.appendChild(wrapper);
            }
          });
          observePosts(); updateVisibility();
        }catch(e){
          console.error('render posts error', e);
          postsContainer.innerHTML=`<div class="error">ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿπÿ±ÿ∂ÿå ÿ≠ÿØŸëÿ´ ÿßŸÑÿµŸÅÿ≠ÿ©.</div>`;
        }
      }, err=>{
        console.error("load posts error",err);
        postsContainer.innerHTML=`<div class="error">ŸÅÿ¥ŸÑ ÿ¨ŸÑÿ® ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™. ÿ≠ÿßŸàŸÑ ŸÑÿßÿ≠ŸÇŸãÿß.</div>`;
      });

      async function initCommentsCount(postId){
        try{ const coll=collection(db,"posts",postId,"comments"); const snap=await getCountFromServer(coll);
             const count=snap.data().count||0; const badge=document.querySelector(`#toggle-${postId} .badge-num`); if(badge) badge.textContent=count;
        }catch(e){console.warn("initCommentsCount error",e);}
      }

      window.toggleComments=function(postId){
        const panel=document.getElementById(`comments-wrap-${postId}`); if(!panel) return;
        const visible=panel.style.display==="block"; panel.style.display=visible?"none":"block"; if(visible) return;
        if(window.commentUnsubMap?.[postId]) return;
        const container=panel.querySelector(".existing-comments");
        const q=query(collection(db,"posts",postId,"comments"),orderBy("createdAt","asc"));
        const unsub=onSnapshot(q,snap=>{
          container.innerHTML=""; let count=0;
          snap.docs.forEach(d=>{ const c=d.data(); const div=document.createElement("div"); div.className="comment";
            const time=c.createdAt&&c.createdAt.toDate?timeAgo(c.createdAt.toDate()):""; div.innerHTML=`<div><strong>${escapeHtml(c.author||"ŸÖÿ≥ÿ™ÿÆÿØŸÖ")}</strong> <small>${time}</small></div><div>${escapeHtml(c.text||"")}</div>`;
            container.appendChild(div); count++; });
          const badge=document.querySelector(`#toggle-${postId} .badge-num`); if(badge) badge.textContent=count;
        },e=>console.warn("comments error",e));
        window.commentUnsubMap=window.commentUnsubMap||{}; window.commentUnsubMap[postId]=unsub;
      };

      window.submitComment=async function(postId){
        const input=document.getElementById(`input-comment-${postId}`); if(!input) return;
        const text=input.value.trim(); if(!text) return;
        try{ await addDoc(collection(db,"posts",postId,"comments"),{text,author:"ŸÖÿ≥ÿ™ÿÆÿØŸÖ",createdAt:serverTimestamp()}); input.value=""; }
        catch(e){ console.error("add comment error",e); window.showToast?.("ÿ™ÿπÿ∞Ÿëÿ± ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ™ÿπŸÑŸäŸÇÿå ÿ≠ÿßŸàŸÑ ŸÑÿßÿ≠ŸÇŸãÿß."); }
      };

      const votes=JSON.parse(localStorage.getItem("votes")||"{}");
      function applyVoteState(postId){
        const choice=votes[postId]; const love=document.getElementById(`love-${postId}`); const dislike=document.getElementById(`dislike-${postId}`);
        if(!love||!dislike) return; love.disabled=false;dislike.disabled=false;love.classList.remove('active');dislike.classList.remove('active');
        if(choice){love.disabled=true;dislike.disabled=true; if(choice==='loves') love.classList.add('active'); if(choice==='dislikes') dislike.classList.add('active');}
      }
      window.applyVoteState=applyVoteState;

      window.vote=async function(postId,field,btn){
        const votes=JSON.parse(localStorage.getItem("votes")||"{}");
        if(votes[postId]){window.showToast?.("ŸÑŸÇÿØ ÿµŸàŸëÿ™ŸëŸé ŸÖÿ≥ÿ®ŸÇŸãÿß ŸÑŸáÿ∞ÿß ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±.");return;}
        try{ const span=btn.querySelector('.count'); span.textContent=(parseInt(span.textContent)||0)+1; btn.classList.add('active');
             document.getElementById(`love-${postId}`).disabled=true; document.getElementById(`dislike-${postId}`).disabled=true;
             await updateDoc(doc(db,"posts",postId),{[field]:increment(1)}); votes[postId]=field; localStorage.setItem("votes",JSON.stringify(votes)); }
        catch(e){ console.error("vote error",e); window.showToast?.("ÿ™ÿπÿ∞Ÿëÿ± ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ™ÿµŸàŸäÿ™ÿå ÿ≠ÿßŸàŸÑ ŸÑÿßÿ≠ŸÇŸãÿß."); applyVoteState(postId); }
      };

      // ÿ®ÿπÿØ ÿ®ŸÜÿßÿ° ÿßŸÑÿ®ÿ∑ÿßŸÇÿßÿ™ ŸÖÿ®ÿßÿ¥ÿ±ÿ© ŸÜÿ≠ÿØŸëÿ´ ÿπÿØÿßÿØ ÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™
      const initObserver=new MutationObserver(()=>{ document.querySelectorAll('.post').forEach(p=>{ const id=p.dataset.postId; if(id) initCommentsCount(id); }); });
      initObserver.observe(postsContainer,{childList:true});
    } else {
      // ÿ®ÿØŸàŸÜ ŸÇÿßÿπÿØÿ© ÿ®ŸäÿßŸÜÿßÿ™: ŸÖÿß ŸÜÿ≥ŸàŸä ÿ¥Ÿäÿ°ÿå ŸÑŸÉŸÜ ŸÖÿß ŸÜŸÉÿ≥ÿ± ÿßŸÑÿµŸÅÿ≠ÿ©
      postsContainer.innerHTML=`<div class="error">ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ ÿ®ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™.</div>`;
    }

    function timeAgo(date){const diff=Math.floor((Date.now()-date.getTime())/1000);if(diff<60)return diff+" ÿ´ŸàÿßŸÜŸä";if(diff<3600)return Math.floor(diff/60)+" ÿØŸÇÿßÿ¶ŸÇ";if(diff<86400)return Math.floor(diff/3600)+" ÿ≥ÿßÿπÿßÿ™";return Math.floor(diff/86400)+" ÿ£ŸäÿßŸÖ";}
    function escapeHtml(str){return String(str).replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));}
  </script>
</body>
</html>
