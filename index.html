<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#00ff88" id="theme-color" />
  <title>Ù…Ù†ØµØ© Ø§Ù„Ø®Ø¯Ù…Ø§Øª - KeFo Posts</title>

  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;600;800&family=Share+Tech+Mono&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg:#050805; --fg:#def7e5; --muted:#7dd08e;
      --primary:#00ff88; --primary-2:#11ffaa; --secondary:#00c06a;
      --card:#071107; --card-2:#0a150a;
      --love:#ff5c93; --danger:#ff4d4d;
      --chip:#07250f;
      --radius:18px; --shadow:0 28px 70px rgba(0,0,0,.55);
      --font:'Cairo',system-ui; --mono:'Share Tech Mono',monospace;
      --featuredGlow: 0 0 0 1px rgba(255,215,0,.35), 0 0 20px rgba(255,215,0,.25);
    }
    .light{
      --bg:#f5fff6; --fg:#08210f; --muted:#3a7b55;
      --primary:#2563eb; --primary-2:#5ea5ff; --secondary:#0d47a1;
      --card:#ffffff; --card-2:#f2fff7; --chip:#eef3ff;
      --love:#e91e63; --danger:#c62828; --shadow:0 18px 40px rgba(2,12,27,.08);
    }
    .pink{
      --bg:#ffecf3; --fg:#3c0a1f; --muted:#8a3a5d;
      --primary:#d81b60; --primary-2:#ff8ad1; --secondary:#880e4f;
      --card:#fff0f6; --card-2:#ffe3ef; --chip:#ffe6f0;
      --love:#ff2f7a; --danger:#c2185b; --shadow:0 18px 40px rgba(0,0,0,.1);
    }

    *,*::before,*::after{box-sizing:border-box;min-width:0}
    html,body{height:100%;width:100%;overflow-x:hidden}
    body{
      margin:0;background:var(--bg);color:var(--fg);font-family:var(--font);
      -webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;
      font-size:clamp(14px,1.8vw,16px);
      -webkit-text-size-adjust:100%;
      touch-action: pan-x pan-y;
    }
    input,select,textarea,button{font-size:16px}
    img,iframe,video{display:block;max-width:100%;width:100%;height:auto}

    #mxRain{position:fixed;inset:0;z-index:-2;opacity:.16;pointer-events:none;filter:drop-shadow(0 0 6px var(--primary));display:block}
    body.light #mxRain, body.pink #mxRain{display:none}
    .mx-overlay{position:fixed;inset:0;z-index:-1;pointer-events:none;opacity:.08;background:
      repeating-linear-gradient(0deg, rgba(0,255,136,.18) 0 1px, transparent 1px 3px),
      repeating-linear-gradient(90deg, rgba(0,255,136,.10) 0 1px, transparent 1px 26px);}
    body.light .mx-overlay, body.pink .mx-overlay{display:none}

    .header{position:fixed;inset-inline:0;top:0;z-index:70;max-width:100vw;
      background:linear-gradient(180deg, rgba(0,20,10,.9), rgba(0,0,0,.55));
      border-bottom:1px solid rgba(0,255,136,.15); backdrop-filter:saturate(1.2) blur(8px);
      color:#fff;display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:10px 12px}
    #searchBar{flex:1;padding:10px 12px;border-radius:999px;border:1px solid rgba(0,255,136,.22);
      background:linear-gradient(180deg, rgba(0,255,136,.08), rgba(0,255,136,.03)); color:var(--fg); min-width:160px; max-width:100%}
    .header-right{margin-inline-start:auto;display:flex;gap:8px;align-items:center}
    .install-btn{display:none;align-items:center;gap:6px;background:linear-gradient(90deg,var(--primary),var(--primary-2));
      color:#071407;border:none;border-radius:999px;padding:6px 10px;cursor:pointer;font-weight:800}
    .badge-gold{display:none;align-items:center;gap:6px;background:linear-gradient(90deg,#ffe57f,#ffd740);
      color:#5b4100;border:none;border-radius:999px;padding:6px 10px;font-weight:900;box-shadow:var(--featuredGlow)}

    /* ØµÙØ­Ø§Øª */
    .page{display:none}
    .page.active{display:block}

    .content{padding:10px;margin:0 auto;width:100%;max-width:1280px}
    #postsContainer{display:grid;grid-template-columns:minmax(0,1fr);gap:16px;width:100%;padding-bottom:120px}
    @media (min-width:900px){#postsContainer{grid-template-columns:repeat(2,minmax(0,1fr));gap:18px}.bottom-nav{display:none}}
    @media (min-width:1400px){#postsContainer{grid-template-columns:repeat(3,minmax(0,1fr));gap:20px}}

    .post{background:linear-gradient(180deg,var(--card),var(--card-2));border-radius:18px;padding:14px;
      box-shadow:var(--shadow),0 0 0 1px rgba(0,255,136,.15) inset;position:relative;overflow:hidden;
      transition:all .25s;opacity:0;transform:translateY(10px);width:100%;min-width:0}
    .post.visible{opacity:1;transform:translateY(0)}
    .post.highlight{outline:2px solid var(--primary); box-shadow:var(--shadow), 0 0 0 2px rgba(0,255,136,.35) inset;}
    .post-header{display:flex;align-items:center;gap:8px;margin-bottom:6px}
    .badge{font-size:12px;font-weight:800;padding:6px 10px;border-radius:999px;color:#071407;background:linear-gradient(90deg,var(--primary),var(--primary-2))}
    .badge.featured{background:linear-gradient(90deg,#ffe57f,#ffd740);color:#5b4100;box-shadow:var(--featuredGlow)}
    .post p{margin:6px 0 10px;color:var(--muted);line-height:1.75;overflow-wrap:anywhere;word-break:break-word}

    .trend, .creators{background:linear-gradient(180deg,var(--card),var(--card-2));border-radius:16px;border:1px solid rgba(0,255,136,.12);box-shadow:var(--shadow);padding:10px}
    .section-title{display:flex;align-items:center;gap:8px;font-weight:900;margin-bottom:8px}
    .section-title i{filter: drop-shadow(0 0 6px rgba(0,255,136,.4))}
    .trend-list{display:flex;gap:10px;overflow-x:auto;padding:4px}
    .trend-card{flex:0 0 230px;background:rgba(0,0,0,.15);border:1px solid rgba(0,255,136,.15);border-radius:12px;padding:10px;cursor:pointer}
    .trend-card .thumb{border-radius:10px;overflow:hidden;aspect-ratio:16/9;background:#000;margin-bottom:6px}
    .creator-list{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
    .creator{display:flex;align-items:center;gap:8px;background:rgba(0,0,0,.12);border:1px solid rgba(0,255,136,.15);border-radius:12px;padding:8px;cursor:pointer}
    .avatar{width:42px;height:42px;border-radius:50%;display:grid;place-items:center;font-weight:900;background:linear-gradient(135deg,#033,#0f6);color:#eaff}
    .creator .meta{display:grid}
    .creator .meta small{color:var(--muted)}
    .follow-btn{margin-inline-start:auto;border:1px solid rgba(0,255,136,.3);background:transparent;color:var(--fg);border-radius:999px;padding:6px 10px;cursor:pointer;font-weight:800}
    .follow-btn.active{background:linear-gradient(90deg,var(--primary),var(--primary-2));color:#071407}
    .full-span{grid-column:1/-1}

    .embed{position:relative;border-radius:14px;overflow:hidden;background:#000;aspect-ratio:16/9;margin-top:10px;
      box-shadow:0 0 0 1px rgba(0,255,136,.25) inset;cursor:pointer}
    .embed-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background-size:cover;background-position:center}
    .embed-overlay::after{content:"";position:absolute;inset:0;background:linear-gradient(to top, rgba(0,0,0,.5), rgba(0,0,0,.15))}
    .embed-big{position:relative;z-index:2;width:80px;height:80px;border-radius:50%;border:none;cursor:pointer;font-size:28px;touch-action:manipulation;
      background:radial-gradient(circle at 30% 30%, #eafff4 0%, #cbffe8 60%, #b0ffd9 100%);box-shadow:0 10px 30px rgba(0,255,136,.35),0 0 30px rgba(0,255,136,.45)}

    .link-card{margin-top:10px;border:1px dashed rgba(0,255,136,.25);border-radius:14px;padding:10px;background:linear-gradient(180deg,rgba(0,0,0,.12),rgba(0,0,0,.06))}
    .link-card .host{font-weight:900;color:var(--muted)}
    .link-card .actions{display:flex;justify-content:flex-end;margin-top:6px}

    .reactions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:stretch}
    .action-vert{display:inline-flex;flex-direction:column;align-items:center;gap:6px;border:none;background:transparent;cursor:pointer;font-size:14px;padding:8px 10px;border-radius:12px;font-weight:800;min-width:76px}
    .action-vert .icon-wrap{position:relative;display:inline-flex;align-items:center;justify-content:center;font-size:22px}
    .action-vert .count-badge{position:absolute;top:-6px;inset-inline-end:-6px;background:var(--primary);color:#071407;font-size:11px;min-width:18px;height:18px;line-height:18px;padding:0 5px;border-radius:10px;border:1px solid rgba(0,0,0,.2);font-weight:900}
    .action-vert .label{font-size:12px;color:var(--muted);font-weight:800}
    .love .icon-wrap i{color:var(--love)} .dislike .icon-wrap i{color:var(--danger)}
    .share .count-badge{display:none}

    .comments-panel{background:rgba(0,0,0,.06);padding:10px;border-radius:14px;margin-top:12px;display:none;border:1px solid rgba(0,0,0,.08)}
    .comment{padding:6px 0;border-bottom:1px dashed rgba(0,0,0,.15)} .comment:last-child{border-bottom:none}
    .comment small{color:var(--muted);margin-inline-start:6px}

    .ad-slider-wrapper{margin:4px 0;background:linear-gradient(180deg,var(--card),var(--card-2));padding:10px;border-radius:18px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,.12);width:100%;min-width:0}
    .ad-slider{display:flex;gap:15px;overflow-x:auto;padding-bottom:5px;scroll-behavior:smooth}
    .ad-slide{flex:0 0 140px;text-align:center}
    .ad-slide a{display:block;color:inherit}
    .ad-circle{width:120px;height:120px;border-radius:50%;overflow:hidden;margin:0 auto 6px;border:2px solid rgba(0,0,0,.12)}
    .ad-circle img{width:100%;height:100%;object-fit:cover}
    .ad-name{font-size:14px;margin-top:4px;color:var(--muted)}

    .bottom-nav{position:fixed;bottom:0;left:0;right:0;display:flex;justify-content:space-around;background:linear-gradient(0deg, rgba(0,0,0,.08), rgba(0,0,0,0));padding:10px 0;border-radius:25px 25px 0 0;border-top:1px solid rgba(0,0,0,.08);box-shadow:0 -4px 16px rgba(0,0,0,.06);z-index:50}

    .modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;align-items:center;justify-content:center;padding:10px;overflow:auto}
    .modal{background:linear-gradient(180deg,var(--card),var(--card-2));border-radius:18px;width:min(720px,92vw);padding:20px;position:relative;box-shadow:var(--shadow);color:var(--fg);border:1px solid rgba(0,0,0,.12)}
    .close-btn{position:absolute;top:8px;inset-inline-end:10px;border:none;background:none;font-size:18px;cursor:pointer;color:var(--fg)}
    .btn{padding:10px 15px;border:none;border-radius:12px;cursor:pointer;background:linear-gradient(90deg,var(--primary),var(--primary-2));color:#071407;font-weight:800;touch-action:manipulation}
    .input,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,.12);margin-bottom:12px;background:#fff;color:#111}
    body:not(.light):not(.pink) .input, body:not(.light):not(.pink) select, body:not(.light):not(.pink) textarea{background:rgba(10,30,15,.85);color:var(--fg);border-color:rgba(0,255,136,.22)}
    .label{font-weight:800;margin-top:5px;display:block}
    .error{background:#2a0f12;color:#ffb0b0;padding:10px;border-radius:12px;margin-bottom:12px;border:1px solid #a33}

    .toast{position:fixed;left:50%;bottom:90px;transform:translateX(-50%) translateY(20px);background:linear-gradient(90deg,var(--primary),var(--primary-2));color:#071407;padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:.3s;z-index:200;font-weight:900}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

    .lightbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:120;align-items:center;justify-content:center;padding:12px}
    .lightbox-content{max-width:min(1100px,96vw);max-height:90vh;position:relative}
    .lb-media{width:min(96vw,1100px);max-height:90vh;aspect-ratio:16/9}
    .lb-media iframe{width:100%;height:100%;display:block;border:0;border-radius:12px}
    .lightbox img{width:auto;max-width:96vw;max-height:90vh;height:auto;display:block;border:0;border-radius:12px}
    .lightbox-close{position:absolute;top:-44px;inset-inline-end:0;background:#000;border:1px solid rgba(255,255,255,.2);color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}

    /* ØµÙØ­Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ */
    #profileHeader{display:flex;gap:12px;align-items:center;background:linear-gradient(180deg,var(--card),var(--card-2));border:1px solid rgba(0,255,136,.15);border-radius:16px;padding:12px;margin-bottom:12px;box-shadow:var(--shadow)}
    #profileHeader .avatar{width:72px;height:72px;font-size:28px}
    .p-meta{display:grid;gap:4px}
    .p-meta .name{font-weight:900;font-size:18px}
    .p-meta .sub{color:var(--muted)}
    .p-stats{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
    .p-chip{background:rgba(0,0,0,.12);border:1px solid rgba(0,255,136,.15);padding:6px 10px;border-radius:999px}
    .p-actions{margin-inline-start:auto;display:flex;gap:8px}
    #profileEdit{display:none;background:linear-gradient(180deg,var(--card),var(--card-2));border:1px solid rgba(0,255,136,.15);border-radius:16px;padding:12px;margin-bottom:12px}
    #profilePosts{display:grid;gap:12px}
  </style>
</head>
<body>

  <!-- Matrix overlays -->
  <canvas id="mxRain"></canvas>
  <div class="mx-overlay"></div>

  <!-- Header -->
  <div class="header">
    <input id="searchBar" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†Ø´ÙˆØ±...">
    <div class="header-right">
      <button id="goldBadge" class="badge-gold">ğŸ–ï¸ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù…ÙŠÙ‘Ø²</button>
      <button id="installBtn" class="install-btn" title="ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚">ğŸ“¥ ØªØ«Ø¨ÙŠØª</button>
      <div class="nav-btn" onclick="openNewPost()"><i>â•</i><div style="font-size:11px;">Ù…Ù†Ø´ÙˆØ±</div></div>
      <div class="nav-btn" onclick="openSettings()"><i>âš™ï¸</i><div style="font-size:11px;">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div></div>
    </div>
  </div>

  <!-- ØµÙØ­Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
  <main id="feedPage" class="page active">
    <div class="content"><div id="postsContainer"></div></div>
  </main>

  <main id="profilePage" class="page">
    <div class="content">
      <div id="profileHeader">
        <div class="avatar">?</div>
        <div class="p-meta">
          <div class="name">â€”</div>
          <div class="sub">â€”</div>
          <div class="p-stats">
            <div class="p-chip" id="pCount">Ù…Ù†Ø´ÙˆØ±Ø§Øª: 0</div>
            <div class="p-chip" id="pLoves">â¤ï¸ 0</div>
          </div>
        </div>
        <div class="p-actions">
          <button class="btn" id="editProfileBtn" style="display:none">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</button>
          <button class="btn" id="followBtn" style="display:none">Ù…ØªØ§Ø¨Ø¹Ø©</button>
          <button class="btn" onclick="history.back()">Ø±Ø¬ÙˆØ¹</button>
        </div>
      </div>

      <div id="profileEdit">
        <div class="error" id="profileError" style="display:none"></div>
        <div style="display:grid;gap:8px">
          <label class="label">Ø§Ù„Ø§Ø³Ù… (ÙØ±ÙŠØ¯)</label>
          <input id="profileNameInput" class="input" placeholder="Ø§Ø³Ù…Ùƒ">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <div>
              <label class="label">Ø³Ù†Ø© Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label>
              <input id="profileBirthYear" type="number" class="input" placeholder="1995" min="1900" max="2100">
              <small id="agePreview" style="color:var(--muted);font-weight:800"></small>
            </div>
            <div>
              <label class="label">Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ù…Ø¯ÙŠÙ†Ø©/Ø¯ÙˆÙ„Ø©)</label>
              <input id="profileLocation" class="input" placeholder="Ø¥Ø³Ø·Ù†Ø¨ÙˆÙ„ØŒ ØªØ±ÙƒÙŠØ§">
            </div>
          </div>
          <label class="label">Ù†Ø¨Ø°Ø© Ù‚ØµÙŠØ±Ø©</label>
          <textarea id="profileBio" class="input" rows="2" placeholder="Ø¹Ø±Ù‘Ù Ø¹Ù† Ù†ÙØ³Ùƒ Ø¨Ø¥ÙŠØ¬Ø§Ø²"></textarea>

          <label class="label">Ø±Ø§Ø¨Ø· Ø´Ø®ØµÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="profileWebsite" class="input" placeholder="https://example.com">

          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button class="btn" onclick="saveProfileNameAndInfo()">Ø­ÙØ¸</button>
            <button class="btn" onclick="toggleProfileEdit(false)">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>
      </div>

      <div id="profilePosts"></div>
    </div>
  </main>

  <!-- Bottom Nav -->
  <div class="bottom-nav">
    <div class="nav-btn" onclick="goHome()"><i>ğŸ </i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
    <div class="nav-btn" onclick="openNewPost()"><i>â•</i>Ø¥Ø¶Ø§ÙØ©</div>
    <div class="nav-btn" onclick="openMyProfile()"><i>ğŸ‘¤</i>Ø§Ù„Ù…Ù„Ù</div>
    <div class="nav-btn" onclick="openSettings()"><i>âš™ï¸</i>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
  </div>

  <!-- Modals: Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯ / Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª / Ø¥Ø­Ø§Ù„Ø§Øª / ØªÙ†Ø¨ÙŠÙ‡ / Lightbox -->
  <div id="newPostModal" class="modal-backdrop">
    <div class="modal">
      <button class="close-btn" onclick="closeNewPost()">âœ–</button>
      <h3>Ù†Ø´Ø± Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯</h3>
      <div id="postError" style="display:none;" class="error"></div>

      <label class="label">Ø§Ø³Ù…Ùƒ (ÙŠÙØ¹Ø±Ø¶ ÙƒÙ†Ø§Ø´Ø±)*</label>
      <input id="authorName" class="input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ" />

      <label class="label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†Ø´ÙˆØ± *</label>
      <select id="postType" class="input">
        <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†Ø´ÙˆØ±</option>
        <option value="Ø³Ø§Ø¹Ø¯Ù†ÙŠ">Ø³Ø§Ø¹Ø¯Ù†ÙŠ</option>
        <option value="Ø´ÙƒÙˆÙ‰ ÙˆÙØ³Ø§Ø¯">Ø´ÙƒÙˆÙ‰ ÙˆÙØ³Ø§Ø¯</option>
        <option value="ØªØ¹Ù„ÙŠÙ…">ØªØ¹Ù„ÙŠÙ…</option>
        <option value="ØµØ­Ø©">ØµØ­Ø©</option>
        <option value="Ù…Ù†Ø´ÙˆØ±Ø§Øª Ù…ØªÙ†ÙˆØ¹Ø©">Ù…Ù†Ø´ÙˆØ±Ø§Øª Ù…ØªÙ†ÙˆØ¹Ø©</option>
      </select>

      <label class="label">Ø§Ù„Ù…Ø­ØªÙˆÙ‰ *</label>
      <textarea id="postContent" class="input" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ±..."></textarea>

      <div id="imageGroup">
        <label class="label">Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© / Ø±Ø§Ø¨Ø· Ù…Ù†Ø´ÙˆØ± Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ (Ù…ÙØ¶Ù‘Ù„)</label>
        <input id="imageURL" type="url" class="input media-input" placeholder="https://example.com/post/... Ø£Ùˆ https://example.com/image.jpg">
      </div>

      <div id="youtubeGroup">
        <label class="label">Ø±Ø§Ø¨Ø· YouTube (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ ÙŠÙÙ„ØºÙÙŠ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©)</label>
        <input id="youtubeURL" type="url" class="input media-input" placeholder="https://www.youtube.com/watch?v=... Ø£Ùˆ youtu.be/...">
      </div>

      <button class="btn" onclick="submitPost()">Ù†Ø´Ø±</button>
    </div>
  </div>

  <div id="settingsModal" class="modal-backdrop">
    <div class="modal">
      <button class="close-btn" onclick="closeSettings()">âœ–</button>
      <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px">
        <button class="btn" style="flex:1" onclick="cycleTheme()">ØªØºÙŠÙŠØ± Ø§Ù„ÙˆØ¶Ø¹</button>
        <div id="themeLabel" style="font-weight:800;color:var(--muted);">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: Ù…Ø§ØªØ±ÙŠÙƒØ³</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button class="btn" style="flex:1" onclick="openReferrals()">Ø¥Ø­Ø§Ù„Ø§ØªÙƒ</button>
      </div>
    </div>
  </div>

  <div id="referralsModal" class="modal-backdrop">
    <div class="modal">
      <button class="close-btn" onclick="closeReferrals()">âœ–</button>
      <h3>Ø¥Ø­Ø§Ù„Ø§ØªÙƒ</h3>
      <p style="color:var(--muted);font-weight:800;line-height:1.8">
        Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„Ùƒ Ø¥Ù„Ù‰ <b>3 Ø¥Ø­Ø§Ù„Ø§Øª</b> Ø£Ùˆ Ø£ÙƒØ«Ø±ØŒ ØªØ¸Ù‡Ø± Ù„Ùƒ <b>Ø´Ø§Ø±Ø© Ù…Ù…ÙŠÙ‘Ø²</b> ÙˆÙŠØªÙ… <b>Ø¥Ø¨Ø±Ø§Ø² Ù…Ù†Ø´ÙˆØ±Ø§ØªÙƒ</b> ÙÙŠ Ø§Ù„Ø®Ù„Ø§ØµØ©.
      </p>
      <div class="trend" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <span>Ø±Ø§Ø¨Ø· Ø¯Ø¹ÙˆØªÙƒ:</span>
        <code id="refLinkModal" style="background:#002b1a;color:#bfffe4;padding:6px 10px;border-radius:8px;border:1px solid rgba(0,255,136,.18)">â€¦</code>
        <button class="btn" onclick="shareInvite()">Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø±Ø§Ø¨Ø·</button>
        <small id="refCountModal" style="color:var(--muted);font-weight:800;margin-inline-start:auto">Ø¥Ø­Ø§Ù„Ø§ØªÙƒ: 0</small>
      </div>
    </div>
  </div>

  <div id="infoModal" class="modal-backdrop">
    <div class="modal">
      <button class="close-btn" onclick="closeInfo()">âœ–</button>
      <h3 id="infoTitle">ØªÙ†Ø¨ÙŠÙ‡</h3>
      <div id="infoBody" style="margin-top:8px;"></div>
      <div style="text-align:end;margin-top:12px;">
        <button class="btn" onclick="closeInfo()">Ø­Ø³Ù†Ù‹Ø§</button>
      </div>
    </div>
  </div>

  <div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·">
    <div class="lightbox-content">
      <button class="lightbox-close" onclick="closeLightbox()">Ø¥ØºÙ„Ø§Ù‚ âœ–</button>
      <div id="lightboxInner"></div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© + Ø­Ù…Ø§ÙŠØ© + PWA + OG endpoint + Router helpers -->
  <script>
    const OG_ENDPOINT = ''; // Ù…Ø«Ù„Ø§Ù‹: 'https://kefo-og.your-subdomain.workers.dev/?url='

    function goHome(){ location.hash = '#/'; }
    function openNewPost(){document.getElementById("newPostModal").style.display="flex";document.body.style.overflow="hidden";syncMediaInputs();loadAuthorField();}
    function closeNewPost(){document.getElementById("newPostModal").style.display="none";document.body.style.overflow="";}
    function openSettings(){document.getElementById("settingsModal").style.display="flex";document.body.style.overflow="hidden";}
    function closeSettings(){document.getElementById("settingsModal").style.display="none";document.body.style.overflow="";}
    function showInfo(title,message){document.getElementById('infoTitle').textContent=title||'ØªÙ†Ø¨ÙŠÙ‡';document.getElementById('infoBody').textContent=message||'';document.getElementById('infoModal').style.display='flex';document.body.style.overflow="hidden";}
    function closeInfo(){document.getElementById('infoModal').style.display='none';document.body.style.overflow="";}
    window.showToast=(msg)=>{const t=document.getElementById('toast');if(!t)return;t.textContent=msg;t.classList.add('show');clearTimeout(window.__toastTimer);window.__toastTimer=setTimeout(()=>t.classList.remove('show'),2200);};

    const themeKey="kefo_theme";
    const names={matrix:"Ù…Ø§ØªØ±ÙŠÙƒØ³", light:"Ù†Ù‡Ø§Ø±ÙŠ", pink:"Ø¨Ù†Ø§ØªÙŠ"};
    function applyTheme(t){
      document.body.classList.remove("light","pink");
      if(t==="light") document.body.classList.add("light");
      else if(t==="pink") document.body.classList.add("pink");
      const color = t==='light' ? '#2563eb' : (t==='pink' ? '#d81b60' : '#00ff88');
      document.getElementById('theme-color')?.setAttribute('content', color);
      localStorage.setItem(themeKey,t);
      const label=document.getElementById('themeLabel'); if(label) label.textContent = "Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: " + (names[t]||names.matrix);
    }
    function cycleTheme(){
      const current = localStorage.getItem(themeKey) || "matrix";
      const next = current==="matrix" ? "light" : current==="light" ? "pink" : "matrix";
      applyTheme(next);
      showToast("ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰: " + (names[next]||"Ù…Ø§ØªØ±ÙŠÙƒØ³"));
    }
    applyTheme(localStorage.getItem(themeKey)||"matrix");

    // Ù…Ù†Ø¹ Ø§Ù„Ø²ÙˆÙ… ÙˆØ§Ù„Ø­Ù…Ø§ÙŠØ©
    ['gesturestart','gesturechange','gestureend'].forEach(evt=>{ window.addEventListener(evt, e=>e.preventDefault(), {passive:false}); });
    document.addEventListener('contextmenu', e=>e.preventDefault());
    document.addEventListener('selectstart', e=>e.preventDefault());
    document.addEventListener('copy', e=>e.preventDefault());
    document.addEventListener('cut', e=>e.preventDefault());
    document.addEventListener('touchstart', e=>{ window.longTouch=setTimeout(()=>e.preventDefault(),500); }, {passive:false});
    document.addEventListener('touchend', ()=>clearTimeout(window.longTouch));

    // PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(console.error); });
    }
    let deferredPrompt=null; const installBtn=document.getElementById('installBtn');
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt=e;
      if (!window.matchMedia('(display-mode: standalone)').matches && !window.navigator.standalone) installBtn.style.display='inline-flex';
    });
    installBtn?.addEventListener('click', async () => { if (!deferredPrompt) return; deferredPrompt.prompt(); const c = await deferredPrompt.userChoice.catch(()=>null); deferredPrompt=null; installBtn.style.display='none'; showToast(c && c.outcome==='accepted' ? 'Ø¬Ø§Ø±ÙŠ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚â€¦' : 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª.'); });
    window.addEventListener('appinstalled',()=>{showToast('ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ âœ…');installBtn.style.display='none';});

    // Lightbox
    const lb=document.getElementById('lightbox');
    const lbInner=document.getElementById('lightboxInner');
    function openLightbox(html){ lbInner.innerHTML=html; lb.style.display='flex'; document.body.style.overflow='hidden'; }
    function closeLightbox(){ lb.style.display='none'; document.body.style.overflow=''; lbInner.innerHTML=''; }
    window.closeLightbox=closeLightbox;
    function ytIdFrom(url){try{const u=new URL(url);let v=u.searchParams.get('v');if(!v){const p=u.pathname.split('/');v=p.pop()||p.pop();}return v||null;}catch{return null;}}
    window.openYouTube = function(id){
      const src=`https://www.youtube-nocookie.com/embed/${id}?rel=0&modestbranding=1&playsinline=1&autoplay=1`;
      openLightbox(`<div class="lb-media"><iframe src="${src}" allow="autoplay; encrypted-media; picture-in-picture; fullscreen" allowfullscreen referrerpolicy="strict-origin-when-cross-origin"></iframe></div>`);
    };
    window.openImage = function(src,alt){ openLightbox(`<img src="${src}" alt="${(alt||'').replace(/"/g,'&quot;')}">`); };

    // ÙˆØ³Ø§Ø¦Ø· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    function syncMediaInputs(){
      const imgVal = document.getElementById('imageURL').value.trim();
      const ytVal  = document.getElementById('youtubeURL').value.trim();
      const imgGroup = document.getElementById('imageGroup');
      const ytGroup  = document.getElementById('youtubeGroup');
      if (imgVal){ ytGroup.style.display='none'; imgGroup.style.display=''; }
      else if(ytVal){ imgGroup.style.display='none'; ytGroup.style.display=''; }
      else { imgGroup.style.display=''; ytGroup.style.display=''; }
    }
    window.addEventListener('input', (e)=>{
      if(e.target && (e.target.id==='imageURL' || e.target.id==='youtubeURL')) syncMediaInputs();
    });

    // Ù‡ÙˆÙŠØ© Ù…Ø­Ù„ÙŠØ©
    function loadAuthorField(){ const stored = localStorage.getItem('authorName') || ''; document.getElementById('authorName').value = stored; }
    function getMyAuthorId(){ let id = localStorage.getItem('authorId'); if(!id){ id='a_'+Math.random().toString(36).slice(2,10); localStorage.setItem('authorId',id);} return id; }
    function ensureRefCode(){ let code = localStorage.getItem('refCode'); if(!code){ code = Math.random().toString(36).slice(2,8).toUpperCase(); localStorage.setItem('refCode', code);} return code; }
    function getSite(){ return (location.origin + location.pathname).replace(/index\.html?$/,''); }
    function updateRefModalUI(){ const code=ensureRefCode(); const url=`${getSite()}?ref=${code}`; const el=document.getElementById('refLinkModal'); if(el) el.textContent=url; }

    function openReferrals(){ updateRefModalUI(); document.getElementById('referralsModal').style.display='flex'; document.body.style.overflow='hidden'; if (typeof loadInvites === 'function') { loadInvites(); } }
    function closeReferrals(){ document.getElementById('referralsModal').style.display='none'; document.body.style.overflow=''; }
    window.openReferrals=openReferrals; window.closeReferrals=closeReferrals;

    window.shareInvite = function(){
      const code = ensureRefCode();
      const url  = `${getSite()}?ref=${code}`;
      const text = `Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ù…Ù†ØµØ© KeFo ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ø¢Ù†!\n${url}`;
      if(navigator.share){ navigator.share({title:'Ø¯Ø¹ÙˆØ© Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ KeFo', text}).catch(()=>{}); }
      else { navigator.clipboard.writeText(text).then(()=>showToast('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©')).catch(()=>alert(text)); }
    }

    function looksLikeDirectImage(u){ return /\.(jpe?g|png|gif|webp|avif)(\?.*)?$/i.test(u||''); }
    async function resolveOG(url){
      if(!OG_ENDPOINT) return null;
      try{ const r = await fetch(OG_ENDPOINT + encodeURIComponent(url)); if(!r.ok) return null;
        const j = await r.json(); if (j && j.ok && j.image) return j;
      }catch(e){ console.warn('OG error', e); }
      return null;
    }

    // Router
    function showPage(id){ document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active'); window.scrollTo({top:0,behavior:'instant'}); }
    function openMyProfile(){ const id=getMyAuthorId(); location.hash = '#/profile/'+id; }
    window.openMyProfile=openMyProfile;
    function route(){
      const h = location.hash || '#/';
      if (h.startsWith('#/profile/by-name/')){
        const name = decodeURIComponent(h.replace('#/profile/by-name/',''));
        window.__openProfileByName?.(name);
        showPage('profilePage');
      } else if (h.startsWith('#/profile/')){
        const id = h.replace('#/profile/','');
        window.__openProfile?.(id);
        showPage('profilePage');
      } else {
        showPage('feedPage');
      }
    }
    window.addEventListener('hashchange', route);
  </script>

  <!-- Firebase + Ø§Ù„Ø®Ù„Ø§ØµØ© + Ø§Ù„ØªØ±Ù†Ø¯ + Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ + Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, query, orderBy, onSnapshot, addDoc, updateDoc, doc,
      serverTimestamp, getCountFromServer, increment, where, getDocs, Timestamp,
      getDoc, setDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA15okly94Qb9XXSMdVdhGg5D4lMqLW1Iw",
      authDomain: "kefo-posts.firebaseapp.com",
      projectId: "kefo-posts",
      storageBucket: "kefo-posts.appspot.com",
      messagingSenderId: "647282320196",
      appId: "1:647282320196:web:9991aa9db6dfec8eb72d11",
      measurementId: "G-R9ZQ566K4H"
    };

    let db;
    try { db = getFirestore(initializeApp(firebaseConfig)); }
    catch(e){ console.error('Firebase init error', e); window.showToast?.('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….'); }

    const postsContainer=document.getElementById("postsContainer");
    const goldBadge   = document.getElementById('goldBadge');

    // Ø¥Ø­Ø§Ù„Ø§Øª
    async function recordReferralIfAny(){
      try{
        const params = new URLSearchParams(location.search);
        const ref = params.get('ref');
        if(ref && !sessionStorage.getItem('ref_seen_'+ref)){
          sessionStorage.setItem('ref_seen_'+ref,'1');
          if(db) await addDoc(collection(db,'referrals'), { ref, ts: serverTimestamp(), ua: navigator.userAgent.slice(0,140) });
        }
      }catch(e){ console.warn('referral record error', e); }
    }

    function getFollowed(){ try{ return JSON.parse(localStorage.getItem('followedAuthors')||'[]'); }catch{ return []; } }
    function setFollowed(list){ localStorage.setItem('followedAuthors', JSON.stringify(list)); }

    let searchText=''; let searchTimeout;
    document.getElementById("searchBar").addEventListener("input", function(){
      clearTimeout(searchTimeout);
      searchText=this.value.toLowerCase();
      searchTimeout=setTimeout(()=>{
        document.querySelectorAll(".post").forEach(p=>{
          p.style.display = p.innerText.toLowerCase().includes(searchText) ? "" : "none";
        });
      },250);
    });

    const adsPool=[{name:"Ø¥Ø¹Ù„Ø§Ù† 1",image:"https://www.shishastore24.de/wp-content/uploads/2023/11/Kefo-3-jpg.jpg",link:"https://example.com/1"},
                   {name:"Ø¥Ø¹Ù„Ø§Ù† 2",image:"https://www.shishastore24.de/wp-content/uploads/2023/11/Kefo-3-jpg.jpg",link:"https://example.com/2"},
                   {name:"Ø¥Ø¹Ù„Ø§Ù† 3",image:"https://via.placeholder.com/120",link:"https://example.com/3"},
                   {name:"Ø¥Ø¹Ù„Ø§Ù† 4",image:"https://via.placeholder.com/120",link:"https://example.com/4"},
                   {name:"Ø¥Ø¹Ù„Ø§Ù† 5",image:"https://via.placeholder.com/120",link:"https://example.com/5"},
                   {name:"Ø¥Ø¹Ù„Ø§Ù† 6",image:"https://via.placeholder.com/120",link:"https://example.com/6"}];
    function getRandomAds(){const copy=[...adsPool];for(let i=copy.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[copy[i],copy[j]]=[copy[j],copy[i]];}return copy.slice(0,4);}

    function ytIdFrom(u){try{const url=new URL(u);let v=url.searchParams.get('v');if(!v){const p=url.pathname.split('/');v=p.pop()||p.pop();}return v||null;}catch{return null;}}
    function toYouTubeThumb(u){ const id=ytIdFrom(u); return id?`https://i.ytimg.com/vi/${id}/hqdefault.jpg`:null; }

    const observer=new IntersectionObserver(entries=>{entries.forEach(e=>{if(e.isIntersecting){e.target.classList.add('visible');observer.unobserve(e.target);}})},{threshold:.1});

    function domainOf(u){ try{ return new URL(u).host.replace(/^www\./,''); }catch{return ''; } }

    function renderMedia(post){
      try{
        if (post.ogImage) {
          const img = post.ogImage.replace(/"/g,'&quot;');
          const srcLink = post.linkURL ? post.linkURL.replace(/"/g,'&quot;') : '#';
          return `
            <div class="embed" style="cursor:zoom-in" onclick="openImage('${img}','ØµÙˆØ±Ø© Ù…Ù† Ø±Ø§Ø¨Ø·')">
              <div class="embed-overlay" style="background-image:url('${img}')"></div>
            </div>
            <div style="display:flex;justify-content:flex-end;margin-top:6px">
              <a href="${srcLink}" target="_blank" rel="noopener" class="btn" style="padding:6px 10px;border-radius:10px;font-size:13px">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø§Ù„Ø£ØµÙ„ÙŠ â†—</a>
            </div>
          `;
        }
        if(post.imageURL){
          const safe=post.imageURL.replace(/"/g,'&quot;');
          return `<img src="${safe}" alt="ØµÙˆØ±Ø©" loading="lazy" onclick="openImage('${safe}','ØµÙˆØ±Ø©')">`;
        }
        if(post.youtubeURL){
          const id = ytIdFrom(post.youtubeURL);
          const thumb=toYouTubeThumb(post.youtubeURL);
          const bg = thumb ? `background-image:url('${thumb}')` : '';
          return `<div class="embed" onclick="openYouTube('${id}')">
            <div class="embed-overlay" style="${bg}">
              <button class="embed-big">â–¶</button>
            </div>
          </div>`;
        }
        if (post.linkURL){
          const host = domainOf(post.linkURL);
          const link = post.linkURL.replace(/"/g,'&quot;');
          return `<div class="link-card">
            <div class="host">ğŸ”— ${host}</div>
            <div class="actions"><a class="btn" href="${link}" target="_blank" rel="noopener" style="padding:6px 10px;border-radius:10px;font-size:13px">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø§Ù„Ø£ØµÙ„ÙŠ â†—</a></div>
          </div>`;
        }
        return '';
      }catch(e){ console.error('renderMedia error', e); return ''; }
    }

    // Ø¯Ø¹ÙˆØ§Øª
    async function loadInvites(){
      try{
        const my = ensureRefCode();
        const qRef = query(collection(db,'referrals'), where('ref','==', my));
        const snap = await getDocs(qRef);
        const count = snap.size || 0;
        const countEl = document.getElementById('refCountModal');
        if(countEl) countEl.textContent = 'Ø¥Ø­Ø§Ù„Ø§ØªÙƒ: ' + count;
        if(count >= 3){ goldBadge.style.display='inline-flex'; }
        else { goldBadge.style.display='none'; }
      }catch(e){ console.warn('invite load error', e); }
    }
    window.loadInvites = loadInvites;

    // ØªØ±Ù†Ø¯
    function buildTrendSection(posts){
      try{
        const now = new Date();
        const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0);
        const today = posts.filter(p=>{
          const d = p.timestamp && p.timestamp.toDate ? p.timestamp.toDate() : null;
          return d && d >= start;
        });
        today.sort((a,b)=>(b.loves||0)-(a.loves||0));
        const top = today.slice(0,6);
        if(!top.length) return null;

        const wrap = document.createElement('div');
        wrap.className = 'trend full-span';
        const list = document.createElement('div');
        list.className = 'trend-list';
        top.forEach(p=>{
          const media = p.ogImage ? `<div class="thumb"><img src="${p.ogImage}" alt=""></div>` :
                        p.imageURL ? `<div class="thumb"><img src="${p.imageURL}" alt=""></div>` :
                        p.youtubeURL ? `<div class="thumb"><img src="${toYouTubeThumb(p.youtubeURL)||''}" alt=""></div>` : `<div class="thumb" style="background:#08160c"></div>`;
          const loves = p.loves||0;
          const type  = p.type||'Ù…Ù†ÙˆÙ‘Ø¹';
          const content = (p.content||'').slice(0,100);
          const card = document.createElement('div');
          card.className='trend-card';
          card.setAttribute('data-post-id', p.id);
          card.innerHTML = `
            ${media}
            <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">
              <span class="badge">âŸ ${type}</span>
              <small style="color:var(--muted);margin-inline-start:auto">â¤ï¸ ${loves}</small>
            </div>
            <div style="color:var(--fg)">${content}</div>
          `;
          card.onclick = ()=> scrollToPost(p.id);
          list.appendChild(card);
        });
        wrap.innerHTML = `<div class="section-title"><i>ğŸ”¥</i><b>Ø§Ù„Ø£ÙƒØ«Ø± ØªÙØ§Ø¹Ù„Ø§Ù‹ Ø§Ù„ÙŠÙˆÙ…</b></div>`;
        wrap.appendChild(list);
        return wrap;
      }catch(e){ console.warn('buildTrendSection error', e); return null; }
    }

    async function buildCreatorsSection(posts){
      try{
        const now = new Date();
        const start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
        const last7 = posts.filter(p=>{
          const d = p.timestamp && p.timestamp.toDate ? p.timestamp.toDate() : null;
          return d && d >= start;
        });

        const agg = {};
        last7.forEach(p=>{
          const aid = p.authorId || ('name:'+ (p.authorName||''));
          agg[aid] = agg[aid] || {score:0, anyName:p.authorName||'Ù…Ø³ØªØ®Ø¯Ù…'};
          agg[aid].score += (p.loves||0);
          if (!agg[aid].anyName && p.authorName) agg[aid].anyName = p.authorName;
        });
        let arr = Object.entries(agg).map(([authorId, v])=>({authorId,score:v.score, anyName:v.anyName}));
        arr.sort((a,b)=>b.score-a.score);
        arr = arr.slice(0,3);
        if(!arr.length) return null;

        const listResolved = [];
        for (const item of arr){
          if(item.authorId.startsWith('a_')){
            const ad = await getDoc(doc(db,'authors', item.authorId)).catch(()=>null);
            const name = ad?.exists() ? (ad.data().name || item.anyName) : item.anyName;
            listResolved.push({...item, name});
          } else {
            listResolved.push({...item, name: item.anyName});
          }
        }

        const wrap = document.createElement('div');
        wrap.className = 'creators full-span';
        wrap.innerHTML = `<div class="section-title"><i>ğŸ†</i><b>Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† (7 Ø£ÙŠØ§Ù…)</b></div>`;
        const list = document.createElement('div');
        list.className = 'creator-list';

        const followed = getFollowed();
        listResolved.forEach(({authorId,score,name})=>{
          const item=document.createElement('div');
          item.className='creator';
          item.setAttribute('data-author-id', authorId);
          const initial = (name.trim()[0] || 'Ù†');
          const isFollow = followed.includes(name);
          item.innerHTML = `
            <div class="avatar">${initial}</div>
            <div class="meta">
              <b>${name}</b>
              <small>â¤ï¸ ${score} ÙÙŠ 7 Ø£ÙŠØ§Ù…</small>
            </div>
            <button class="follow-btn ${isFollow?'active':''}" data-name="${name}" onclick="event.stopPropagation();">
              ${isFollow?'Ù…ØªØ§Ø¨ÙØ¹':'Ù…ØªØ§Ø¨Ø¹Ø©'}
            </button>
          `;
          item.onclick = ()=>{
            if(authorId.startsWith('a_')) location.hash = '#/profile/'+authorId;
            else location.hash = '#/profile/by-name/'+encodeURIComponent(name);
          };
          list.appendChild(item);
        });
        wrap.appendChild(list);

        setTimeout(()=>{
          wrap.querySelectorAll('.follow-btn').forEach(btn=>{
            btn.onclick = (ev)=>{
              ev.stopPropagation();
              const name = btn.getAttribute('data-name');
              let list = getFollowed();
              if(list.includes(name)){ list = list.filter(n=>n!==name); btn.classList.remove('active'); btn.textContent='Ù…ØªØ§Ø¨Ø¹Ø©'; }
              else { list.push(name); btn.classList.add('active'); btn.textContent='Ù…ØªØ§Ø¨ÙØ¹'; window.showToast?.('Ø³ØªÙØ¨Ø±Ø² Ù…Ù†Ø´ÙˆØ±Ø§Øª '+name+' Ù„Ø¯ÙŠÙƒ'); }
              setFollowed(list);
            };
          });
        });
        return wrap;
      }catch(e){ console.warn('buildCreatorsSection error', e); return null; }
    }

    window.scrollToPost = function(id){
      const el = document.getElementById('post-'+id);
      if(!el){ location.hash='#/'; setTimeout(()=>{ const el2=document.getElementById('post-'+id); if(el2){ el2.scrollIntoView({behavior:'smooth'}); el2.classList.add('highlight'); setTimeout(()=> el2.classList.remove('highlight'), 1600);} },300); return; }
      el.scrollIntoView({behavior:'smooth', block:'start'});
      el.classList.add('highlight');
      setTimeout(()=> el.classList.remove('highlight'), 1600);
    };

    if (db){
      const postsQ=query(collection(db,"posts"),orderBy("timestamp","desc"));
      onSnapshot(postsQ, async (snap)=>{
        const posts=snap.docs.map(d=>({id:d.id,...d.data()}));

        postsContainer.innerHTML = posts.length ? "" : `<div class="error">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`;

        const trendSec = buildTrendSection(posts);
        if (trendSec) postsContainer.appendChild(trendSec);

        const creatorsSec = await buildCreatorsSection(posts);
        if (creatorsSec) postsContainer.appendChild(creatorsSec);

        const followed = getFollowed();
        const myName = localStorage.getItem('authorName') || '';
        const highlightAuthor = goldBadge.style.display!=='none' ? myName.trim() : null;

        let postCount = 0;
        posts.forEach((post)=>{
          const loves=post.loves||0, dislikes=post.dislikes||0;
          const card=document.createElement('div'); card.className='post'; card.dataset.postId=post.id; card.id='post-'+post.id;

          const shareLink = post.ogImage || post.imageURL || post.youtubeURL || post.linkURL || location.href;
          const safeText  = (post.content||'').replace(/"/g,'&quot;');
          const author    = (post.authorName||'Ù…Ø³ØªØ®Ø¯Ù…').replace(/</g,'&lt;');
          const featured  = (highlightAuthor && post.authorName===highlightAuthor) ? ' featured' : '';

          card.innerHTML=`
            <div class="post-header">
              <span class="badge${featured}">âŸ ${post.type||'Ù…Ù†ÙˆÙ‘Ø¹'}</span>
              <small style="color:var(--muted);margin-inline-start:auto">âœï¸ <a href="#/profile/${post.authorId||''}" style="color:inherit;text-decoration:none">${author}</a></small>
            </div>
            <p>${post.content||''}</p>
            ${renderMedia(post)}
            <div class="reactions">
              <button class="action-vert love" id="love-${post.id}" onclick="vote('${post.id}','loves', this)">
                <span class="icon-wrap"><i>â¤ï¸</i><b class="count-badge">${loves}</b></span>
                <span class="label">Ø¥Ø¹Ø¬Ø§Ø¨</span>
              </button>
              <button class="action-vert dislike" id="dislike-${post.id}" onclick="vote('${post.id}','dislikes', this)">
                <span class="icon-wrap"><i>ğŸ‘</i><b class="count-badge">${dislikes}</b></span>
                <span class="label">Ø¹Ø¯Ù… Ø¥Ø¹Ø¬Ø§Ø¨</span>
              </button>
              <button class="action-vert comments" id="toggle-${post.id}" onclick="toggleComments('${post.id}')">
                <span class="icon-wrap"><i>ğŸ’¬</i><b class="count-badge" id="cnum-${post.id}">0</b></span>
                <span class="label">ØªØ¹Ù„ÙŠÙ‚Ø§Øª</span>
              </button>
              <button class="action-vert share" onclick="sharePost('${safeText}','${shareLink}')">
                <span class="icon-wrap"><i>ğŸ”—</i><b class="count-badge">0</b></span>
                <span class="label">Ù…Ø´Ø§Ø±ÙƒØ©</span>
              </button>
            </div>
            <div class="comments-panel" id="comments-wrap-${post.id}">
              <div style="margin-top:6px;"><strong>Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</strong></div>
              <div class="existing-comments" style="margin-top:6px;"></div>
              <div style="margin-top:8px;display:flex;gap:6px;">
                <input id="input-comment-${post.id}" class="input" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ..." style="flex:1;">
                <button class="btn" style="flex:0 0 auto;" onclick="submitComment('${post.id}')">Ø£Ø¶Ù</button>
              </div>
            </div>`;
          postsContainer.appendChild(card);
          observer.observe(card);

          postCount++;
          if(postCount%5===0){
            const wrapper=document.createElement('div'); wrapper.className='ad-slider-wrapper full-span';
            const slider=document.createElement('div'); slider.className='ad-slider';
            getRandomAds().forEach(ad=>{ const slide=document.createElement('div'); slide.className='ad-slide';
              slide.innerHTML=`<a href="${ad.link}" target="_blank" rel="noopener"><div class="ad-circle"><img src="${ad.image}" alt="${ad.name}" loading="lazy"></div><div class="ad-name">${ad.name}</div></a>`;
              slider.appendChild(slide);
            });
            postsContainer.appendChild(wrapper);
            wrapper.appendChild(slider);
          }

          if (followed.includes(post.authorName||'')){
            card.style.outline='1px solid rgba(0,255,136,.35)';
            card.style.boxShadow='var(--shadow), 0 0 20px rgba(0,255,136,.15) inset';
          }
        });

        document.querySelectorAll('.post').forEach(p=>{ const id=p.dataset.postId; if(id) initCommentsCount(id); });
      }, err=>{
        console.error("load posts error",err);
        postsContainer.innerHTML=`<div class="error">ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.</div>`;
      });

      async function initCommentsCount(postId){
        try{
          const coll=collection(db,"posts",postId,"comments");
          const snap=await getCountFromServer(coll);
          const count=snap.data().count||0;
          const badge=document.getElementById(`cnum-${postId}`);
          if(badge) badge.textContent=count;
        }catch(e){console.warn("initCommentsCount error",e);}
      }

      window.toggleComments=function(postId){
        const panel=document.getElementById(`comments-wrap-${postId}`); if(!panel) return;
        const visible=panel.style.display==="block"; panel.style.display=visible?"none":"block"; if(visible) return;

        const container=panel.querySelector(".existing-comments");
        const q=query(collection(db,"posts",postId,"comments"),orderBy("createdAt","asc"));
        onSnapshot(q,snap=>{
          container.innerHTML=""; let count=0;
          snap.docs.forEach(d=>{ const c=d.data(); const div=document.createElement("div"); div.className="comment";
            const time=c.createdAt&&c.createdAt.toDate?timeAgo(c.createdAt.toDate()):""; div.innerHTML=`<div><strong>${escapeHtml(c.author||"Ù…Ø³ØªØ®Ø¯Ù…")}</strong> <small>${time}</small></div><div>${escapeHtml(c.text||"")}</div>`;
            container.appendChild(div); count++; });
          const badge=document.getElementById(`cnum-${postId}`); if(badge) badge.textContent=count;
        },e=>console.warn("comments error",e));
      };

      window.submitComment=async function(postId){
        const input=document.getElementById(`input-comment-${postId}`); if(!input) return;
        const text=input.value.trim(); if(!text) return;
        try{ await addDoc(collection(db,"posts",postId,"comments"),{text,author:"Ù…Ø³ØªØ®Ø¯Ù…",createdAt:serverTimestamp()}); input.value=""; }
        catch(e){ console.error("add comment error",e); window.showToast?.("ØªØ¹Ø°Ù‘Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§."); }
      };

      window.vote=async function(postId,field,btn){
        const v=JSON.parse(localStorage.getItem("votes")||"{}");
        if(v[postId]){window.showToast?.("Ù„Ù‚Ø¯ ØµÙˆÙ‘ØªÙ‘Ù Ù…Ø³Ø¨Ù‚Ù‹Ø§ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø´ÙˆØ±.");return;}
        try{
          const badge=btn.querySelector('.count-badge');
          badge.textContent=(parseInt(badge.textContent)||0)+1;
          document.getElementById(`love-${postId}`).disabled=true; document.getElementById(`dislike-${postId}`).disabled=true;
          await updateDoc(doc(db,"posts",postId),{[field]:increment(1)});
          v[postId]=field; localStorage.setItem("votes",JSON.stringify(v));
        }catch(e){ console.error("vote error",e); window.showToast?.("ØªØ¹Ø°Ù‘Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØµÙˆÙŠØªØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§."); }
      };

      window.sharePost = function(text, mediaUrl){
        const site = (location.origin + location.pathname).replace(/index\.html?$/,'');
        const parts = []; if(text){ parts.push(text); } if(mediaUrl){ parts.push(mediaUrl); }
        parts.push(`âœ¨ Ø²Ø± Ù…ÙˆÙ‚Ø¹Ù†Ø§ Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰: ${site}`);
        const message = parts.join('\n');
        if(navigator.share){ navigator.share({ title:"Ù…Ù†ØµØ© KeFo", text: message }).catch(()=>{}); }
        else{ navigator.clipboard.writeText(message).then(()=>showToast("ØªÙ… Ù†Ø³Ø® Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© âœ¨")).catch(()=>{ alert(message); }); }
      };

      // â€”â€” Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠØ¯ / Ø§Ù„Ù…Ø¤Ù„Ù â€”â€”
      function normalizeName(n){ return (n||'').trim(); }
      function nameLower(n){ return normalizeName(n).toLowerCase(); }
      async function claimAuthorName(authorId, desiredName){
        const clean = normalizeName(desiredName);
        if(!clean) return {ok:false, reason:'empty'};
        const qx = query(collection(db,'authors'), where('nameLower','==', nameLower(clean)));
        const snap = await getDocs(qx);
        let takenBy = null; snap.forEach(d=>{ takenBy = d.id; });
        if(takenBy && takenBy !== authorId){
          const suggestion = clean + Math.floor(100 + Math.random()*900);
          return {ok:true, name:suggestion, changed:true};
        }
        return {ok:true, name:clean, changed:false};
      }
      async function ensureAuthorDoc(authorId, partial){
        const ref = doc(db,'authors', authorId);
        const exist = await getDoc(ref);
        if(exist.exists()){ await updateDoc(ref, {...partial, updatedAt: serverTimestamp()}); }
        else { await setDoc(ref, {...partial, createdAt: serverTimestamp(), updatedAt: serverTimestamp()}); }
      }
      async function renameAllMyPosts(authorId, newName){
        const qx = query(collection(db,'posts'), where('authorId','==', authorId));
        const snap = await getDocs(qx);
        const ops = []; snap.forEach(d=>{ ops.push(updateDoc(doc(db,'posts', d.id), { authorName: newName })); });
        await Promise.all(ops);
      }

      // Ù†Ø´Ø±
      window.submitPost = async function(){
        const type = document.getElementById("postType").value;
        const content = document.getElementById("postContent").value.trim();
        const imageURLInput = document.getElementById("imageURL").value.trim();
        const youtubeURL = document.getElementById("youtubeURL").value.trim();
        let authorName = document.getElementById("authorName").value.trim();
        const errorDiv = document.getElementById("postError");

        errorDiv.style.display="none";
        if(!type || !content){ errorDiv.textContent = "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†Ø´ÙˆØ± ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰"; errorDiv.style.display="block"; return; }

        const authorId = localStorage.getItem('authorId') || (()=>{ const id='a_'+Math.random().toString(36).slice(2,10); localStorage.setItem('authorId', id); return id; })();

        const claim = await claimAuthorName(authorId, authorName || (localStorage.getItem('authorName')||''));
        if(!claim.ok){ errorDiv.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµØ§Ù„Ø­."; errorDiv.style.display="block"; return; }
        if(claim.changed){ showInfo('Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…','Ø§Ø®ØªØ±Ù†Ø§ Ù„Ùƒ Ø§Ø³Ù…Ù‹Ø§ Ù…Ù‚ØªØ±Ø­Ù‹Ø§: '+claim.name+' â€” ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ±Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ.'); }
        authorName = claim.name;
        localStorage.setItem('authorName', authorName);
        await ensureAuthorDoc(authorId, { name: authorName, nameLower: nameLower(authorName) });

        let payload = {
          type, content, authorName, authorId,
          imageURL: null, youtubeURL: null,
          linkURL: null, ogImage: null,
          loves:0, dislikes:0,
          timestamp: serverTimestamp()
        };

        if (youtubeURL) {
          payload.youtubeURL = youtubeURL;
        } else if (imageURLInput) {
          if (looksLikeDirectImage(imageURLInput)) {
            payload.imageURL = imageURLInput;
          } else {
            payload.linkURL = imageURLInput;
            try{
              if (OG_ENDPOINT){
                const og = await resolveOG(imageURLInput);
                if (og && og.image) payload.ogImage = og.image;
              }
            }catch{}
          }
        }

        try{
          await addDoc(collection(db, "posts"), payload);
          closeNewPost();
          window.showToast?.("ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ± âœ…");
          document.getElementById("postType").value="";
          document.getElementById("postContent").value="";
          document.getElementById("imageURL").value="";
          document.getElementById("youtubeURL").value="";
          setTimeout(()=>syncMediaInputs(),0);
        }catch(e){
          console.error("submitPost error", e);
          errorDiv.textContent="ÙØ´Ù„ Ø§Ù„Ù†Ø´Ø±ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.";
          errorDiv.style.display="block";
        }
      };

      // â€”â€”â€” ØµÙØ­Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ â€”â€”â€”
      const pHeader = document.getElementById('profileHeader');
      const pAvatar = pHeader.querySelector('.avatar');
      const pName   = pHeader.querySelector('.name');
      const pSub    = pHeader.querySelector('.sub');
      const pCount  = document.getElementById('pCount');
      const pLoves  = document.getElementById('pLoves');
      const editBtn = document.getElementById('editProfileBtn');
      const followBtn = document.getElementById('followBtn');
      const pEdit   = document.getElementById('profileEdit');
      const pErr    = document.getElementById('profileError');
      const inName  = document.getElementById('profileNameInput');
      const inYear  = document.getElementById('profileBirthYear');
      const inLoc   = document.getElementById('profileLocation');
      const inBio   = document.getElementById('profileBio');
      const inWeb   = document.getElementById('profileWebsite');
      const agePrev = document.getElementById('agePreview');
      const pPosts  = document.getElementById('profilePosts');

      function ageFromYear(y){ const Y = parseInt(y,10); if(!Y) return ''; const now=new Date().getFullYear(); const a = now - Y; return (a>=0 && a<=120) ? a : ''; }
      inYear?.addEventListener('input',()=>{ const a = ageFromYear(inYear.value); agePrev.textContent = a ? ('Ø§Ù„Ø¹Ù…Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ: '+a) : ''; });

      function toggleProfileEdit(v){ pEdit.style.display = v ? 'block' : 'none'; }
      window.toggleProfileEdit = toggleProfileEdit;

      async function loadProfile(authorId, byName=null){
        try{
          pPosts.innerHTML='â€¦';
          pErr.style.display='none';

          let profile = { name:'', birthYear:null, bio:'', location:'', website:'' };
          if (authorId && !byName){
            const aDoc = await getDoc(doc(db,'authors', authorId)).catch(()=>null);
            if (aDoc?.exists()){
              const d=aDoc.data();
              profile = { name:d.name||'', birthYear:d.birthYear||'', bio:d.bio||'', location:d.location||'', website:d.website||'' };
            }
          }
          let isMine = (authorId === (localStorage.getItem('authorId')||''));
          let nameResolved = profile.name;

          // Ø¥Ù† Ù„Ù… Ù†Ø¬Ø¯ ÙˆØ«ÙŠÙ‚Ø© Ù…Ø¤Ù„ÙØŒ ÙˆØ­Ø¶Ø±Ù†Ø§ byName
          if (byName){
            nameResolved = byName;
          } else if (!nameResolved){
            // Ø¬Ø±Ù‘Ø¨ Ø£ÙˆÙ„ Ù…Ù†Ø´ÙˆØ± Ù„Ø§Ø³ØªÙ†ØªØ§Ø¬ Ø§Ù„Ø§Ø³Ù…
            const qx = query(collection(db,'posts'), where('authorId','==', authorId), orderBy('timestamp','desc'));
            const snap = await getDocs(qx);
            if(!snap.empty){ nameResolved = (snap.docs[0].data().authorName||''); }
          }

          // Ø¹Ù†ÙˆØ§Ù† + Ø£ÙØ§ØªØ§Ø±
          const initial = (nameResolved?.trim?.()[0] || 'Ù†').toUpperCase();
          pAvatar.textContent = initial;
          pName.textContent = nameResolved || 'Ù…Ø³ØªØ®Ø¯Ù…';
          const ageText = profile.birthYear ? (' â€¢ Ø§Ù„Ø¹Ù…Ø± ~ ' + ageFromYear(profile.birthYear)) : '';
          const locText = profile.location ? (' â€” ' + profile.location) : '';
          pSub.innerHTML = (profile.bio || '') + (ageText ? ` <span style="opacity:.7">${ageText}</span>` : '') + (locText ? ` <span style="opacity:.7">${locText}</span>` : '');

          // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø±
          editBtn.style.display = isMine ? 'inline-block' : 'none';
          followBtn.style.display = isMine ? 'none' : 'inline-block';

          // Ø²Ø± ØªØ¹Ø¯ÙŠÙ„
          editBtn.onclick = ()=>{
            inName.value = nameResolved || (localStorage.getItem('authorName')||'');
            inYear.value = profile.birthYear || '';
            inLoc.value  = profile.location || '';
            inBio.value  = profile.bio || '';
            inWeb.value  = profile.website || '';
            agePrev.textContent = profile.birthYear ? ('Ø§Ù„Ø¹Ù…Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ: '+ageFromYear(profile.birthYear)) : '';
            toggleProfileEdit(true);
          };

          // Ø²Ø± Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø­Ù„ÙŠ (ØªØ²ÙŠÙŠÙ†ÙŠ)
          const followed = JSON.parse(localStorage.getItem('followedAuthors')||'[]');
          const isFollow = followed.includes(nameResolved);
          followBtn.textContent = isFollow ? 'Ù…ØªØ§Ø¨ÙØ¹' : 'Ù…ØªØ§Ø¨Ø¹Ø©';
          followBtn.onclick = ()=>{
            let arr = JSON.parse(localStorage.getItem('followedAuthors')||'[]');
            if (isFollow){ arr = arr.filter(n=>n!==nameResolved); followBtn.textContent='Ù…ØªØ§Ø¨Ø¹Ø©'; }
            else { arr.push(nameResolved); followBtn.textContent='Ù…ØªØ§Ø¨ÙØ¹'; showToast('Ø³ØªÙØ¨Ø±Ø² Ù…Ù†Ø´ÙˆØ±Ø§Øª '+nameResolved); }
            localStorage.setItem('followedAuthors', JSON.stringify(arr));
          };

          // Ø¬Ù„Ø¨ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
          let qPosts;
          if (byName){
            qPosts = query(collection(db,'posts'), where('authorName','==', byName), orderBy('timestamp','desc'));
          } else {
            qPosts = query(collection(db,'posts'), where('authorId','==', authorId), orderBy('timestamp','desc'));
          }
          const ps = await getDocs(qPosts);
          pPosts.innerHTML = '';
          let totalLoves = 0;
          if (ps.empty){
            pPosts.innerHTML = `<div class="error">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª.</div>`;
          } else {
            ps.docs.forEach(d=>{
              const p = d.data();
              totalLoves += (p.loves||0);
              const row = document.createElement('div');
              row.className='post';
              row.innerHTML = `
                <div class="post-header">
                  <span class="badge">âŸ ${p.type||'Ù…Ù†ÙˆÙ‘Ø¹'}</span>
                  <small style="color:var(--muted);margin-inline-start:auto">${(p.authorName||'Ù…Ø³ØªØ®Ø¯Ù…')}</small>
                </div>
                <p>${(p.content||'')}</p>
                ${renderMedia(p)}
                ${isMine ? `<div style="display:flex;justify-content:flex-end;margin-top:8px;">
                  <button class="btn" onclick="deleteMyPost('${d.id}')">Ø­Ø°Ù</button>
                </div>` : ``}
              `;
              pPosts.appendChild(row);
            });
          }
          pCount.textContent = 'Ù…Ù†Ø´ÙˆØ±Ø§Øª: ' + ps.size;
          pLoves.textContent = 'â¤ï¸ ' + totalLoves;

          // Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ù„Ù
          window.__currentProfile = { authorId, byName, nameResolved, isMine };
        }catch(e){
          console.error(e);
          pErr.textContent='ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ'; pErr.style.display='block';
        }
      }

      async function saveProfileNameAndInfo(){
        try{
          const cur = window.__currentProfile || {};
          const myId = localStorage.getItem('authorId')||'';
          if(!cur.isMine || !myId){ showToast('Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'); return; }

          const desired = (document.getElementById('profileNameInput').value||'').trim();
          const birthYear = (document.getElementById('profileBirthYear').value||'').trim();
          const location  = (document.getElementById('profileLocation').value||'').trim();
          const bio       = (document.getElementById('profileBio').value||'').trim();
          const website   = (document.getElementById('profileWebsite').value||'').trim();

          const claim = await (async ()=>{
            const clean = desired || (localStorage.getItem('authorName')||'');
            if(!clean) return {ok:false, reason:'empty'};
            const qx = query(collection(db,'authors'), where('nameLower','==', clean.toLowerCase()));
            const s = await getDocs(qx);
            let takenBy = null; s.forEach(d=>{ takenBy = d.id; });
            if(takenBy && takenBy !== myId){
              const suggestion = clean + Math.floor(100 + Math.random()*900);
              return {ok:true, name:suggestion, changed:true};
            }
            return {ok:true, name:clean, changed:false};
          })();
          if(!claim.ok){ pErr.textContent='Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ù‹Ø§ ØµØ§Ù„Ø­Ù‹Ø§'; pErr.style.display='block'; return; }
          if(claim.changed){ showInfo('Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…','Ø§Ù‚ØªØ±Ø­Ù†Ø§ Ù„Ùƒ: '+claim.name+' â€” ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ±Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§.'); }

          const finalName = claim.name;
          await ensureAuthorDoc(myId, {
            name: finalName, nameLower: finalName.toLowerCase(),
            birthYear: birthYear? Number(birthYear): null,
            location, bio, website
          });
          localStorage.setItem('authorName', finalName);
          await renameAllMyPosts(myId, finalName);

          toggleProfileEdit(false);
          showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ');
          loadProfile(myId);
        }catch(e){
          console.error(e);
          const pErr = document.getElementById('profileError');
          pErr.textContent='ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸'; pErr.style.display='block';
        }
      }
      window.saveProfileNameAndInfo = saveProfileNameAndInfo;

      window.deleteMyPost = async function(postId){
        const authorId = localStorage.getItem('authorId');
        if(!authorId) return;
        try{
          const ref = doc(db,'posts', postId);
          const pd = await getDoc(ref);
          if(!pd.exists()) return;
          const p = pd.data();
          if(p.authorId !== authorId){ showToast('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ù…Ù†Ø´ÙˆØ± Ù„Ø§ ØªÙ…Ù„ÙƒÙ‡'); return; }
          const cSnap = await getDocs(collection(db,'posts', postId, 'comments'));
          const dels = []; cSnap.forEach(c=>{ dels.push(deleteDoc(doc(db,'posts', postId, 'comments', c.id))); });
          await Promise.all(dels);
          await deleteDoc(ref);
          showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±');
          loadProfile(authorId);
        }catch(e){ console.error(e); showToast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­Ø°Ù'); }
      };

      // Ø±Ø¨Ø· Ø¯ÙˆØ§Ù„ Ù„Ù„Ø±Ø§ÙˆØªØ±
      window.__openProfile = (id)=> loadProfile(id, null);
      window.__openProfileByName = (name)=> loadProfile(null, name);

      // ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
      recordReferralIfAny();
      await loadInvites();
      window.route(); // Ø£Ø¸Ù‡Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ù‡Ø§Ø´
      setInterval(()=>{ loadInvites(); }, 60*1000);

    } else {
      postsContainer.innerHTML=`<div class="error">ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</div>`;
    }

    function timeAgo(date){const diff=Math.floor((Date.now()-date.getTime())/1000);if(diff<60)return diff+" Ø«ÙˆØ§Ù†ÙŠ";if(diff<3600)return Math.floor(diff/60)+" Ø¯Ù‚Ø§Ø¦Ù‚";if(diff<86400)return Math.floor(diff/3600)+" Ø³Ø§Ø¹Ø§Øª";return Math.floor(diff/86400)+" Ø£ÙŠØ§Ù…";}
    function escapeHtml(str){return String(str).replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));}
  </script>
</body>
</html>
