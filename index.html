<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <!-- Ù…Ù†Ø¹ Ø§Ù„Ø²ÙˆÙ… + ØªØ«Ø¨ÙŠØª Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#00ff88" id="theme-color" />
  <title>Ù…Ù†ØµØ© Ø§Ù„Ø®Ø¯Ù…Ø§Øª - KeFo Posts</title>

  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;600;800&family=Share+Tech+Mono&display=swap" rel="stylesheet" />

  <style>
    /* ======== Themes ======== */
    :root{ /* Matrix (default) */
      --bg:#050805; --fg:#def7e5; --muted:#7dd08e;
      --primary:#00ff88; --primary-2:#11ffaa; --secondary:#00c06a;
      --card:#071107; --card-2:#0a150a;
      --love:#ff5c93; --danger:#ff4d4d;
      --chip:#07250f;
      --radius:18px; --shadow:0 28px 70px rgba(0,0,0,.55);
      --font:'Cairo',system-ui; --mono:'Share Tech Mono',monospace;
    }
    .light{
      --bg:#f5fff6; --fg:#08210f; --muted:#3a7b55;
      --primary:#2563eb; --primary-2:#5ea5ff; --secondary:#0d47a1;
      --card:#ffffff; --card-2:#f2fff7; --chip:#eef3ff;
      --love:#e91e63; --danger:#c62828;
      --shadow:0 18px 40px rgba(2,12,27,.08);
    }
    .pink{
      --bg:#ffecf3; --fg:#3c0a1f; --muted:#8a3a5d;
      --primary:#d81b60; --primary-2:#ff8ad1; --secondary:#880e4f;
      --card:#fff0f6; --card-2:#ffe3ef; --chip:#ffe6f0;
      --love:#ff2f7a; --danger:#c2185b;
      --shadow:0 18px 40px rgba(0,0,0,.1);
    }

    /* ØªØµÙÙŠØ± Ù…Ù‡Ù… Ù„Ù…Ù†Ø¹ ØªÙ…Ø¯Ø¯ Ø¹Ù†Ø§ØµØ± Grid */
    *,*::before,*::after{box-sizing:border-box; min-width:0}

    html,body{height:100%; width:100%; overflow-x:hidden}
    body{
      margin:0;background:var(--bg);color:var(--fg);font-family:var(--font);
      -webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;
      font-size:clamp(14px,1.8vw,16px);
      -webkit-text-size-adjust:100%; -ms-text-size-adjust:100%;
      touch-action: pan-x pan-y;
    }
    input,select,textarea,button{font-size:16px}
    img, iframe, video{display:block;max-width:100%;width:100%;height:auto}

    /* Matrix rain (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ø§ØªØ±ÙŠÙƒØ³) */
    #mxRain{position:fixed;inset:0;z-index:-2;opacity:.16;pointer-events:none;filter:drop-shadow(0 0 6px var(--primary));display:block}
    body.light #mxRain, body.pink #mxRain{display:none}
    .mx-overlay{position:fixed;inset:0;z-index:-1;pointer-events:none;opacity:.08;background:
      repeating-linear-gradient(0deg, rgba(0,255,136,.18) 0 1px, transparent 1px 3px),
      repeating-linear-gradient(90deg, rgba(0,255,136,.10) 0 1px, transparent 1px 26px);}
    body.light .mx-overlay, body.pink .mx-overlay{display:none}

    /* Header */
    .header{position:fixed;inset-inline:0;top:0;z-index:60;max-width:100vw;
      background:linear-gradient(180deg, rgba(0,20,10,.9), rgba(0,0,0,.55));
      border-bottom:1px solid rgba(0,255,136,.15); backdrop-filter:saturate(1.2) blur(8px);
      color:#fff;display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:10px 12px}
    #searchBar{flex:1;padding:10px 12px;border-radius:999px;border:1px solid rgba(0,255,136,.22);
      background:linear-gradient(180deg, rgba(0,255,136,.08), rgba(0,255,136,.03)); color:var(--fg); min-width:160px; max-width:100%}
    .header-right{margin-inline-start:auto;display:flex;gap:8px}
    .install-btn{display:none;align-items:center;gap:6px;background:linear-gradient(90deg,var(--primary),var(--primary-2));
      color:#071407;border:none;border-radius:999px;padding:6px 10px;cursor:pointer;font-weight:800}

    /* Filters */
    .filters{position:sticky;top:58px;z-index:55;padding:8px 0;margin:0 auto;max-width:1280px;width:100%}
    .chips{display:flex;gap:8px;overflow:auto;padding:8px 10px}
    .chip{padding:6px 12px;border-radius:999px;border:1px solid rgba(0,255,136,.18);background:var(--chip);color:var(--fg);cursor:pointer;white-space:nowrap}
    .chip.active{background:rgba(0,255,136,.18);box-shadow:0 0 16px rgba(0,255,136,.25)}

    /* Content grid */
    .content{padding:120px 10px 140px;margin:0 auto;width:100%;max-width:1280px}
    #postsContainer{display:grid;grid-template-columns:minmax(0,1fr);gap:16px;width:100%}
    @media (min-width:900px){.content{padding:130px 20px 40px}#postsContainer{grid-template-columns:repeat(2,minmax(0,1fr));gap:18px}.bottom-nav{display:none}}
    @media (min-width:1400px){#postsContainer{grid-template-columns:repeat(3,minmax(0,1fr));gap:20px}}

    /* Card */
    .post{background:linear-gradient(180deg,var(--card),var(--card-2));border-radius:18px;padding:14px;
      box-shadow:var(--shadow),0 0 0 1px rgba(0,255,136,.15) inset;position:relative;overflow:hidden;
      transition:all .25s;opacity:0;transform:translateY(10px);width:100%;min-width:0}
    .post.visible{opacity:1;transform:translateY(0)}
    .post-header{display:flex;align-items:center;gap:8px;margin-bottom:6px}
    .badge{font-size:12px;font-weight:800;padding:6px 10px;border-radius:999px;color:#071407;background:linear-gradient(90deg,var(--primary),var(--primary-2))}
    .post p{margin:6px 0 10px;color:var(--muted);line-height:1.75;overflow-wrap:anywhere;word-break:break-word}

    /* Embed */
    .embed{position:relative;border-radius:14px;overflow:hidden;background:#000;aspect-ratio:16/9;margin-top:10px;
      box-shadow:0 0 0 1px rgba(0,255,136,.25) inset;cursor:pointer}
    .embed-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background-size:cover;background-position:center}
    .embed-overlay::after{content:"";position:absolute;inset:0;background:linear-gradient(to top, rgba(0,0,0,.5), rgba(0,0,0,.15))}
    .embed-big{position:relative;z-index:2;width:80px;height:80px;border-radius:50%;border:none;cursor:pointer;font-size:28px;touch-action:manipulation;
      background:radial-gradient(circle at 30% 30%, #eafff4 0%, #cbffe8 60%, #b0ffd9 100%);box-shadow:0 10px 30px rgba(0,255,136,.35),0 0 30px rgba(0,255,136,.45)}

    /* Reactions / comments */
    .reactions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center}
    .react-btn{border:none;background:transparent;cursor:pointer;display:flex;align-items:center;gap:6px;font-size:16px;padding:8px 10px;border-radius:12px;transition:.2s;font-weight:800;touch-action:manipulation}
    .react-btn[disabled]{opacity:.6;cursor:not-allowed}
    .react-love i{color:var(--love)} .react-dislike i{color:var(--danger)} .count{font-weight:800}
    .comments-panel{background:rgba(0,0,0,.06);padding:10px;border-radius:14px;margin-top:12px;display:none;border:1px solid rgba(0,0,0,.08)}
    .comment{padding:6px 0;border-bottom:1px dashed rgba(0,0,0,.15)} .comment:last-child{border-bottom:none}
    .comment small{color:var(--muted);margin-inline-start:6px}
    .comments-toggle{border:none;background:none;cursor:pointer;display:flex;align-items:center;gap:6px;font-size:16px;padding:6px 8px;border-radius:8px}
    .badge-num{display:inline-block;min-width:18px;padding:0 6px;height:18px;line-height:18px;font-size:12px;border-radius:10px;background:var(--primary);color:#071407;text-align:center;font-weight:800}

    /* Ads */
    .ad-slider-wrapper{margin:4px 0;background:linear-gradient(180deg,var(--card),var(--card-2));padding:10px;border-radius:18px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,.12);width:100%;min-width:0}
    .ad-slider{display:flex;gap:15px;overflow-x:auto;padding-bottom:5px;scroll-behavior:smooth}
    .ad-slide{flex:0 0 140px;text-align:center}
    .ad-slide a{display:block;color:inherit}
    .ad-circle{width:120px;height:120px;border-radius:50%;overflow:hidden;margin:0 auto 6px;border:2px solid rgba(0,0,0,.12)}
    .ad-circle img{width:100%;height:100%;object-fit:cover}
    .ad-name{font-size:14px;margin-top:4px;color:var(--muted)}
    .ad-note{background:rgba(0,0,0,.06);padding:10px;text-align:center;color:var(--fg);font-weight:800;margin-top:8px;border-radius:12px;border:1px solid rgba(0,0,0,.08)}
    .full-span{grid-column:1/-1}

    /* Bottom nav */
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;display:flex;justify-content:space-around;background:linear-gradient(0deg, rgba(0,0,0,.08), rgba(0,0,0,0));padding:10px 0;border-radius:25px 25px 0 0;border-top:1px solid rgba(0,0,0,.08);box-shadow:0 -4px 16px rgba(0,0,0,.06);z-index:50}

    /* Modals + Toast */
    .modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;align-items:center;justify-content:center;padding:10px;overflow:auto}
    .modal{background:linear-gradient(180deg,var(--card),var(--card-2));border-radius:18px;width:min(520px,92vw);padding:20px;position:relative;box-shadow:var(--shadow);color:var(--fg);border:1px solid rgba(0,0,0,.12)}
    .close-btn{position:absolute;top:8px;inset-inline-end:10px;border:none;background:none;font-size:18px;cursor:pointer;color:var(--fg)}
    .btn{padding:10px 15px;border:none;border-radius:12px;cursor:pointer;background:linear-gradient(90deg,var(--primary),var(--primary-2));color:#071407;font-weight:800;touch-action:manipulation}
    .input,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,.12);margin-bottom:12px;background:#fff;color:#111}
    body:not(.light):not(.pink) .input, body:not(.light):not(.pink) select, body:not(.light):not(.pink) textarea{background:rgba(10,30,15,.85);color:var(--fg);border-color:rgba(0,255,136,.22)}
    .label{font-weight:800;margin-top:5px;display:block}
    .error{background:#2a0f12;color:#ffb0b0;padding:10px;border-radius:12px;margin-bottom:12px;border:1px solid #a33}

    .toast{position:fixed;left:50%;bottom:90px;transform:translateX(-50%) translateY(20px);background:linear-gradient(90deg,var(--primary),var(--primary-2));color:#071407;padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:.3s;z-index:200;font-weight:900}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

    /* Lightbox (ØµÙˆØ±/ÙÙŠØ¯ÙŠÙˆ) */
    .lightbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:120;align-items:center;justify-content:center;padding:12px}
    .lightbox-content{max-width:min(1100px,96vw);max-height:90vh;position:relative}
    .lb-media{width:min(96vw,1100px);max-height:90vh;aspect-ratio:16/9}
    .lb-media iframe{width:100%;height:100%;display:block;border:0;border-radius:12px}
    .lightbox img{width:auto;max-width:96vw;max-height:90vh;height:auto;display:block;border:0;border-radius:12px}
    .lightbox-close{position:absolute;top:-44px;inset-inline-end:0;background:#000;border:1px solid rgba(255,255,255,.2);color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}

    /* Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© */
    .lightbox:fullscreen,
    .lightbox:-webkit-full-screen{background:#000}
    .lightbox:fullscreen .lightbox-content,
    .lightbox:-webkit-full-screen .lightbox-content{width:100vw;height:100vh;max-width:100vw;max-height:100vh}
    .lightbox:fullscreen .lb-media,
    .lightbox:-webkit-full-screen .lb-media{width:100vw;height:100vh;max-width:100vw;max-height:100vh;aspect-ratio:auto}
    .lightbox:fullscreen iframe,
    .lightbox:-webkit-full-screen iframe{width:100%;height:100%}
  </style>
</head>
<body>

  <!-- Matrix background -->
  <canvas id="mxRain"></canvas>
  <div class="mx-overlay"></div>

  <!-- Header -->
  <div class="header">
    <input id="searchBar" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†Ø´ÙˆØ±...">
    <div class="header-right">
      <button id="installBtn" class="install-btn" title="ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚">ğŸ“¥ ØªØ«Ø¨ÙŠØª</button>
      <div class="nav-btn" onclick="openNewPost()"><i>â•</i><div style="font-size:11px;">Ù…Ù†Ø´ÙˆØ±</div></div>
      <div class="nav-btn" onclick="openSettings()"><i>âš™ï¸</i><div style="font-size:11px;">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div></div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters"><div id="chips" class="chips"></div></div>

  <!-- Content -->
  <div class="content"><div id="postsContainer"></div></div>

  <!-- Bottom nav -->
  <div class="bottom-nav">
    <div class="nav-btn" onclick="openNewPost()"><i>â•</i>Ø¥Ø¶Ø§ÙØ©</div>
    <div class="nav-btn" onclick="showToast('Ù‚Ø³Ù… Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±')"><i>ğŸ’¬</i>Ø¯Ø±Ø¯Ø´Ø©</div>
    <div class="nav-btn" onclick="showToast('Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±')"><i>ğŸ“‚</i>Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
    <div class="nav-btn" onclick="showToast('Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±')"><i>ğŸ‘¤</i>Ø§Ù„Ù…Ù„Ù</div>
    <div class="nav-btn" onclick="openSettings()"><i>âš™ï¸</i>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
  </div>

  <!-- New post modal -->
  <div id="newPostModal" class="modal-backdrop">
    <div class="modal">
      <button class="close-btn" onclick="closeNewPost()">âœ–</button>
      <h3>Ù†Ø´Ø± Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯</h3>
      <div id="postError" style="display:none;" class="error"></div>

      <label class="label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†Ø´ÙˆØ± *</label>
      <select id="postType" class="input">
        <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†Ø´ÙˆØ±</option>
        <option value="Ø³Ø§Ø¹Ø¯Ù†ÙŠ">Ø³Ø§Ø¹Ø¯Ù†ÙŠ</option>
        <option value="Ø´ÙƒÙˆÙ‰ ÙˆÙØ³Ø§Ø¯">Ø´ÙƒÙˆÙ‰ ÙˆÙØ³Ø§Ø¯</option>
        <option value="ØªØ¹Ù„ÙŠÙ…">ØªØ¹Ù„ÙŠÙ…</option>
        <option value="ØµØ­Ø©">ØµØ­Ø©</option>
        <option value="Ù…Ù†Ø´ÙˆØ±Ø§Øª Ù…ØªÙ†ÙˆØ¹Ø©">Ù…Ù†Ø´ÙˆØ±Ø§Øª Ù…ØªÙ†ÙˆØ¹Ø©</option>
      </select>

      <label class="label">Ø§Ù„Ù…Ø­ØªÙˆÙ‰ *</label>
      <textarea id="postContent" class="input" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ±..."></textarea>

      <!-- Media: ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· -->
      <label class="label">Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ ÙŠÙÙ„ØºÙÙŠ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·)</label>
      <div class="input-row">
        <input id="imageURL" type="url" class="input media-input" placeholder="https://example.com/image.jpg">
      </div>

      <label class="label">Ø±Ø§Ø¨Ø· YouTube (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ ÙŠÙÙ„ØºÙÙŠ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·)</label>
      <div class="input-row">
        <input id="youtubeURL" type="url" class="input media-input" placeholder="https://www.youtube.com/watch?v=... Ø£Ùˆ youtu.be/...">
      </div>

      <label class="label">Ø±Ø§Ø¨Ø· Facebook (ÙÙŠØ¯ÙŠÙˆ/Ø±ÙŠÙ„Ø²) (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ ÙŠÙÙ„ØºÙÙŠ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·)</label>
      <div class="input-row">
        <input id="facebookURL" type="url" class="input media-input" placeholder="https://www.facebook.com/reel/... Ø£Ùˆ .../videos/...">
      </div>

      <button class="btn" onclick="submitPost()">Ù†Ø´Ø±</button>
    </div>
  </div>

  <!-- Settings modal -->
  <div id="settingsModal" class="modal-backdrop">
    <div class="modal">
      <button class="close-btn" onclick="closeSettings()">âœ–</button>
      <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button class="btn" style="flex:1" onclick="cycleTheme()">ØªØºÙŠÙŠØ± Ø§Ù„ÙˆØ¶Ø¹</button>
        <div id="themeLabel" style="font-weight:800;color:var(--muted);">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: Ù…Ø§ØªØ±ÙŠÙƒØ³</div>
      </div>
    </div>
  </div>

  <!-- Info modal -->
  <div id="infoModal" class="modal-backdrop">
    <div class="modal">
      <button class="close-btn" onclick="closeInfo()">âœ–</button>
      <h3 id="infoTitle">ØªÙ†Ø¨ÙŠÙ‡</h3>
      <div id="infoBody" style="margin-top:8px;"></div>
      <div style="text-align:end;margin-top:12px;">
        <button class="btn" onclick="closeInfo()">Ø­Ø³Ù†Ù‹Ø§</button>
      </div>
    </div>
  </div>

  <!-- Lightbox (ØµÙˆØ±/ÙÙŠØ¯ÙŠÙˆ) -->
  <div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="Ù…Ø´ØºÙ„ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·">
    <div class="lightbox-content">
      <button class="lightbox-close" onclick="closeLightbox()">Ø¥ØºÙ„Ø§Ù‚ âœ–</button>
      <div id="lightboxInner"></div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- UI + Themes + PWA + Rain + Lightbox -->
  <script>
    /* Modals */
    function openNewPost(){document.getElementById("newPostModal").style.display="flex";document.body.style.overflow="hidden";}
    function closeNewPost(){document.getElementById("newPostModal").style.display="none";document.body.style.overflow="";}
    function openSettings(){document.getElementById("settingsModal").style.display="flex";document.body.style.overflow="hidden";}
    function closeSettings(){document.getElementById("settingsModal").style.display="none";document.body.style.overflow="";}
    function showInfo(title,message){document.getElementById('infoTitle').textContent=title||'ØªÙ†Ø¨ÙŠÙ‡';document.getElementById('infoBody').textContent=message||'';document.getElementById('infoModal').style.display='flex';document.body.style.overflow="hidden";}
    function closeInfo(){document.getElementById('infoModal').style.display='none';document.body.style.overflow="";}
    window.showToast=(msg)=>{const t=document.getElementById('toast');if(!t)return;t.textContent=msg;t.classList.add('show');clearTimeout(window.__toastTimer);window.__toastTimer=setTimeout(()=>t.classList.remove('show'),2200);};

    /* Themes (matrix default) */
    const themeKey="kefo_theme";
    const names={matrix:"Ù…Ø§ØªØ±ÙŠÙƒØ³", light:"Ù†Ù‡Ø§Ø±ÙŠ", pink:"Ø¨Ù†Ø§ØªÙŠ"};
    function applyTheme(t){
      document.body.classList.remove("light","pink");
      if(t==="light") document.body.classList.add("light");
      else if(t==="pink") document.body.classList.add("pink");
      const color = t==='light' ? '#2563eb' : (t==='pink' ? '#d81b60' : '#00ff88');
      document.getElementById('theme-color')?.setAttribute('content', color);
      localStorage.setItem(themeKey,t);
      const label=document.getElementById('themeLabel'); if(label) label.textContent = "Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: " + (names[t]||names.matrix);
    }
    function cycleTheme(){
      const current = localStorage.getItem(themeKey) || "matrix";
      const next = current==="matrix" ? "light" : current==="light" ? "pink" : "matrix";
      applyTheme(next);
      showToast("ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰: " + (names[next]||"Ù…Ø§ØªØ±ÙŠÙƒØ³"));
    }
    applyTheme(localStorage.getItem(themeKey)||"matrix");

    /* Ù…Ù†Ø¹ Ø§Ù„ØªÙ…Ø¯Ø¯ Ø§Ù„Ø£ÙÙ‚ÙŠ */
    window.addEventListener('load',()=>{
      document.querySelectorAll('img,iframe,video').forEach(el=>{el.style.maxWidth='100%';el.style.width='100%';});
    });

    /* ØªØ¹Ø·ÙŠÙ„ Pinch/Double-tap Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù† */
    ['gesturestart','gesturechange','gestureend'].forEach(evt=>{
      window.addEventListener(evt, e=>e.preventDefault(), {passive:false});
    });

    /* PWA */
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(console.error); });
    }
    let deferredPrompt=null; const installBtn=document.getElementById('installBtn');
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt=e; if (!window.matchMedia('(display-mode: standalone)').matches && !window.navigator.standalone) installBtn.style.display='inline-flex'; });
    installBtn?.addEventListener('click', async () => { if (!deferredPrompt) return; deferredPrompt.prompt(); const c = await deferredPrompt.userChoice.catch(()=>null); deferredPrompt=null; installBtn.style.display='none'; showToast(c && c.outcome==='accepted' ? 'Ø¬Ø§Ø±ÙŠ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚â€¦' : 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª.'); });
    window.addEventListener('appinstalled',()=>{showToast('ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ âœ…');installBtn.style.display='none';});

    /* Matrix rain (only matrix) */
    const canvas=document.getElementById('mxRain'), ctx=canvas.getContext('2d');
    let w,h,font=16,cols,drops,raf;
    function rainResize(){ w=canvas.width=window.innerWidth; h=canvas.height=window.innerHeight; cols=Math.floor(w/font); drops=new Array(cols).fill( Math.floor(Math.random()*h/font) ); }
    function rainDraw(){ if(document.body.classList.contains('light')||document.body.classList.contains('pink')) { cancelAnimationFrame(raf); return; }
      ctx.fillStyle='rgba(0,12,6,0.12)'; ctx.fillRect(0,0,w,h);
      ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--primary').trim()||'#00ff88';
      ctx.font=font+'px "Share Tech Mono", monospace';
      for(let i=0;i<drops.length;i++){ const char=Math.random()>0.5?'0':'1'; ctx.fillText(char, i*font, drops[i]*font); if(drops[i]*font > h && Math.random() > 0.965) drops[i]=0; drops[i]++; }
      raf=requestAnimationFrame(rainDraw);
    }
    window.addEventListener('resize',()=>{cancelAnimationFrame(raf);rainResize();rainDraw();});
    rainResize(); rainDraw();

    /* ====== Lightbox (ØµÙˆØ±/ÙÙŠØ¯ÙŠÙˆ) + Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© ====== */
    const lb=document.getElementById('lightbox'); const lbInner=document.getElementById('lightboxInner');

    function openLightbox(contentHtml){
      lbInner.innerHTML=contentHtml;
      lb.style.display='flex'; document.body.style.overflow='hidden';
    }
    function closeLightbox(){
      lb.style.display='none'; document.body.style.overflow='';
      lbInner.innerHTML=''; // ØªÙØ±ÙŠØº Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
      // ÙÙƒ Ù‚ÙÙ„ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø¥Ù† ÙƒØ§Ù† Ù…Ù‚ÙÙˆÙ„Ø§Ù‹
      if (screen.orientation && screen.orientation.unlock) { try { screen.orientation.unlock(); } catch(e){} }
      // Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Ù„Ùˆ Ù…Ø§ Ø®Ø±Ø¬
      if (document.fullscreenElement || document.webkitFullscreenElement) {
        (document.exitFullscreen || document.webkitExitFullscreen)?.call(document);
      }
      window.removeEventListener('resize', adjustFbReelInFullscreen);
      document.removeEventListener('fullscreenchange', onFsChange);
      document.removeEventListener('webkitfullscreenchange', onFsChange);
    }
    window.closeLightbox=closeLightbox;

    // Ø·Ù„Ø¨ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© + Ù‚ÙÙ„ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ (Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹)
    async function tryAutoFullscreen(orientation /* 'portrait' | 'landscape' */){
      const el = lb;
      const req = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen;
      try {
        if (req) { await req.call(el); }
        if (screen.orientation && screen.orientation.lock && orientation) {
          try { await screen.orientation.lock(orientation); } catch(_) {}
        }
      } catch(err){ console.warn('Fullscreen not allowed:', err); }
    }

    function ytIdFrom(url){try{const u=new URL(url);let v=u.searchParams.get('v');if(!v){const p=u.pathname.split('/');v=p.pop()||p.pop();}return v||null;}catch{return null;}}
    function isFacebookReel(urlStr){
      try{
        const u = new URL(urlStr);
        const p = u.pathname.toLowerCase();
        return p.includes('/reel/') || p.includes('/reels/') || u.searchParams.has('reel_id');
      }catch{ return false; }
    }

    // ÙŠÙˆØªÙŠÙˆØ¨ (16:9 + Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Landscape)
    function openYouTube(id){
      const src=`https://www.youtube-nocookie.com/embed/${id}?rel=0&modestbranding=1&playsinline=1&autoplay=1`;
      openLightbox(`<div class="lb-media"><iframe src="${src}" allow="autoplay; encrypted-media; picture-in-picture; fullscreen" allowfullscreen referrerpolicy="strict-origin-when-cross-origin"></iframe></div>`);
      setTimeout(()=>tryAutoFullscreen('landscape'), 0);
    }

    // ÙÙŠØ³Ø¨ÙˆÙƒ: ØªÙØ±Ù‚Ø© Ø¨ÙŠÙ† Ø±ÙŠÙ„Ø² (9:16) ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¹Ø§Ø¯ÙŠ (16:9)
    function openFacebook(url){
      if (isFacebookReel(url)) openFacebookReel(url);
      else openFacebookVideo(url);
    }

    // ÙÙŠØ¯ÙŠÙˆ ÙÙŠØ³Ø¨ÙˆÙƒ Ø¹Ø§Ø¯ÙŠ (16:9)
    function openFacebookVideo(url){
      const maxW = Math.min(window.innerWidth*0.96, 1100);
      const maxH = window.innerHeight*0.90;
      let h = Math.floor(maxW * 9 / 16 + 64);
      if (h > maxH) { h = Math.floor(maxH); }
      const w = Math.floor(Math.min(maxW, h * 16 / 9));
      const src=`https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(url)}&show_text=false&allowfullscreen=true&autoplay=true&width=${w}&height=${h}`;
      openLightbox(`
        <div style="width:${w}px; max-width:96vw;">
          <iframe
            src="${src}"
            style="border:none;overflow:hidden; width:100%; height:${h}px"
            scrolling="no"
            allow="autoplay; encrypted-media; fullscreen; picture-in-picture; web-share"
            allowfullscreen="true"
            referrerpolicy="no-referrer">
          </iframe>
        </div>
      `);
      setTimeout(()=>tryAutoFullscreen('landscape'), 0);
    }

    // Ø±ÙŠÙ„Ø² (9:16) Ø·ÙˆÙ„ÙŠ + Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Portrait
    function calcPortraitDims(){
      // Ù†ÙØ¶Ù‘Ù„ Ù…Ù„Ø¡ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ØŒ Ø«Ù… Ù†Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø±Ø¶ 9/16
      let vh = window.innerHeight, vw = window.innerWidth;
      let h = Math.floor(vh * 0.98);
      let w = Math.floor(h * 9 / 16);
      if (w > vw*0.98){ // Ù„Ùˆ Ø§Ù„Ø¹Ø±Ø¶ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø©ØŒ Ù†ÙƒÙŠÙ‘Ù Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶
        w = Math.floor(vw * 0.98);
        h = Math.floor(w * 16 / 9);
      }
      // Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù…Ù†Ø·Ù‚ÙŠ
      w = Math.max(300, w);
      h = Math.max(480, h);
      return { w, h };
    }

    function openFacebookReel(url){
      const {w,h} = calcPortraitDims();
      const src=`https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(url)}&show_text=false&allowfullscreen=true&autoplay=true&width=${w}&height=${h}`;
      openLightbox(`
        <div id="fbReelWrap" style="width:${w}px;height:${h}px;max-width:100vw;max-height:100vh;display:flex;align-items:center;justify-content:center;">
          <iframe
            id="fbReelFrame"
            src="${src}"
            style="border:none;overflow:hidden; width:100%; height:100%"
            scrolling="no"
            allow="autoplay; encrypted-media; fullscreen; picture-in-picture; web-share"
            allowfullscreen="true"
            referrerpolicy="no-referrer">
          </iframe>
        </div>
      `);

      // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙ‘Ø± Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø´Ø§Ø´Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ù„Ø¡
      document.addEventListener('fullscreenchange', onFsChange);
      document.addEventListener('webkitfullscreenchange', onFsChange);
      window.addEventListener('resize', adjustFbReelInFullscreen);

      // Ø§Ø¯Ø®Ù„ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Portrait
      setTimeout(()=>tryAutoFullscreen('portrait'), 0);
    }

    function onFsChange(){
      // Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Ø£Ùˆ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù†Ù‡ØŒ Ø§Ø¶Ø¨Ø· Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ù…Ù† Ø¬Ø¯ÙŠØ¯
      adjustFbReelInFullscreen();
    }

    function adjustFbReelInFullscreen(){
      const wrap = document.getElementById('fbReelWrap');
      if (!wrap) return;
      // ÙÙŠ Ø§Ù„Ù…Ù„Ø¡: Ø§Ù…Ù„Ø£ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ØŒ ÙˆØ§Ø¶Ø¨Ø· Ø§Ù„Ø¹Ø±Ø¶ 9/16
      const vh = window.innerHeight, vw = window.innerWidth;
      let h = Math.floor(vh);
      let w = Math.floor(h * 9 / 16);
      if (w > vw){ w = vw; h = Math.floor(w * 16 / 9); }
      wrap.style.width = w + 'px';
      wrap.style.height = h + 'px';
    }

    // ØµÙˆØ±Ø©
    function openImage(src,alt){
      openLightbox(`<img src="${src}" alt="${(alt||'').replace(/"/g,'&quot;')}">`);
    }

    // Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø£Ùˆ Ø¨Ø§Ù„Ù€Esc
    const lb=document.getElementById('lightbox');
    lb.addEventListener('click',e=>{ if(e.target===lb) closeLightbox(); });
    window.addEventListener('keydown',e=>{ if(e.key==='Escape' && lb.style.display==='flex') closeLightbox(); });
  </script>

  <!-- Firebase + Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, updateDoc, doc, serverTimestamp, getCountFromServer, increment } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA15okly94Qb9XXSMdVdhGg5D4lMqLW1Iw",
      authDomain: "kefo-posts.firebaseapp.com",
      projectId: "kefo-posts",
      storageBucket: "kefo-posts.appspot.com",
      messagingSenderId: "647282320196",
      appId: "1:647282320196:web:9991aa9db6dfec8eb72d11",
      measurementId: "G-R9ZQ566K4H"
    };

    let db;
    try { db = getFirestore(initializeApp(firebaseConfig)); }
    catch(e){ console.error('Firebase init error', e); window.showToast?.('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…ØŒ Ø³ØªØ¸Ù‡Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„.'); }

    const postsContainer=document.getElementById("postsContainer");
    const chipsEl=document.getElementById("chips");
    const filterTypes=[{key:'Ø§Ù„ÙƒÙ„',label:'Ø§Ù„ÙƒÙ„'},{key:'Ø³Ø§Ø¹Ø¯Ù†ÙŠ',label:'Ø³Ø§Ø¹Ø¯Ù†ÙŠ'},{key:'Ø´ÙƒÙˆÙ‰ ÙˆÙØ³Ø§Ø¯',label:'Ø´ÙƒÙˆÙ‰ ÙˆÙØ³Ø§Ø¯'},{key:'ØªØ¹Ù„ÙŠÙ…',label:'ØªØ¹Ù„ÙŠÙ…'},{key:'ØµØ­Ø©',label:'ØµØ­Ø©'},{key:'Ù…Ù†Ø´ÙˆØ±Ø§Øª Ù…ØªÙ†ÙˆØ¹Ø©',label:'Ù…Ù†ÙˆÙ‘Ø¹'}];
    let activeFilter='Ø§Ù„ÙƒÙ„', searchText='';

    function buildChips(){ chipsEl.innerHTML=''; filterTypes.forEach(t=>{const b=document.createElement('button'); b.className='chip'+(t.key===activeFilter?' active':''); b.textContent=t.label; b.onclick=()=>{activeFilter=t.key; buildChips(); updateVisibility();}; chipsEl.appendChild(b);}); }
    buildChips();

    function showSkeletons(n=6){ postsContainer.innerHTML=''; for(let i=0;i<n;i++){const sk=document.createElement('div'); sk.className='skeleton skeleton-card'; postsContainer.appendChild(sk);} }
    showSkeletons();

    function ytIdFrom(u){try{const url=new URL(u);let v=url.searchParams.get('v');if(!v){const p=url.pathname.split('/');v=p.pop()||p.pop();}return v||null;}catch{return null;}}
    function toYouTubeThumb(u){ const id=ytIdFrom(u); return id?`https://i.ytimg.com/vi/${id}/hqdefault.jpg`:null; }

    function renderMedia(post){
      try{
        if(post.imageURL){
          const safe=post.imageURL.replace(/"/g,'&quot;');
          return `<img src="${safe}" alt="ØµÙˆØ±Ø©" loading="lazy" onclick="openImage('${safe}','ØµÙˆØ±Ø©')">`;
        }

        if(post.youtubeURL){
          const id = ytIdFrom(post.youtubeURL);
          const thumb=toYouTubeThumb(post.youtubeURL);
          return `<div class="embed" onclick="openYouTube('${id}')">
            <div class="embed-overlay" style="${thumb?`background-image:url('${thumb}')`:''}">
              <button class="embed-big">â–¶</button>
            </div>
          </div>`;
        }

        if(post.facebookURL){
          const safe = encodeURI(post.facebookURL);
          // Ù†ÙØ³ Ø§Ù„Ù€openFacebook Ø³ÙŠÙ‚Ø±Ù‘Ø± Ø¥Ù† ÙƒØ§Ù† Ø±ÙŠÙ„Ø² Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ Ø¹Ø§Ø¯ÙŠ
          return `<div class="embed" onclick="openFacebook('${safe}')">
            <div class="embed-overlay" style="background-image:linear-gradient(45deg,#3b5998,#8b9dc3)">
              <button class="embed-big">â–¶</button>
            </div>
          </div>`;
        }

        return '';
      }catch(e){ console.error('renderMedia error', e); return ''; }
    }

    const observer=new IntersectionObserver(entries=>{entries.forEach(e=>{if(e.isIntersecting){e.target.classList.add('visible');observer.unobserve(e.target);}})},{threshold:.1});
    function updateVisibility(){ const posts=document.querySelectorAll(".post"); posts.forEach(p=>{const matchesType=(activeFilter==='Ø§Ù„ÙƒÙ„')||(p.dataset.type===activeFilter); const matchesText=!searchText||p.innerText.toLowerCase().includes(searchText); p.style.display=(matchesType&&matchesText)?'':'none';}); }
    let searchTimeout;
    document.getElementById("searchBar").addEventListener("input", function(){ clearTimeout(searchTimeout); searchText=this.value.toLowerCase(); searchTimeout=setTimeout(updateVisibility,250); });

    const adsPool=[{name:"Ø¥Ø¹Ù„Ø§Ù† 1",image:"https://www.shishastore24.de/wp-content/uploads/2023/11/Kefo-3-jpg.jpg",link:"https://example.com/1"},{name:"Ø¥Ø¹Ù„Ø§Ù† 2",image:"https://www.shishastore24.de/wp-content/uploads/2023/11/Kefo-3-jpg.jpg",link:"https://example.com/2"},{name:"Ø¥Ø¹Ù„Ø§Ù† 3",image:"https://via.placeholder.com/120",link:"https://example.com/3"},{name:"Ø¥Ø¹Ù„Ø§Ù† 4",image:"https://via.placeholder.com/120",link:"https://example.com/4"},{name:"Ø¥Ø¹Ù„Ø§Ù† 5",image:"https://via.placeholder.com/120",link:"https://example.com/5"},{name:"Ø¥Ø¹Ù„Ø§Ù† 6",image:"https://via.placeholder.com/120",link:"https://example.com/6"}];
    function getRandomAds(){const copy=[...adsPool];for(let i=copy.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[copy[i],copy[j]]=[copy[j],copy[i]];}return copy.slice(0,4);}

    if (db){
      const postsQ=query(collection(db,"posts"),orderBy("timestamp","desc"));
      onSnapshot(postsQ, snap=>{
        const posts=snap.docs.map(d=>({id:d.id,...d.data()}));
        postsContainer.innerHTML = posts.length ? "" : `<div class="error">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`;

        posts.forEach((post,i)=>{
          const loves=post.loves||0, dislikes=post.dislikes||0;
          const card=document.createElement('div'); card.className='post'; card.dataset.type=post.type||''; card.dataset.postId=post.id;

          card.innerHTML=`
            <div class="post-header"><span class="badge">âŸ ${post.type||'Ù…Ù†ÙˆÙ‘Ø¹'}</span></div>
            <p>${post.content||''}</p>
            ${renderMedia(post)}
            <div class="reactions">
              <button class="react-btn react-love" id="love-${post.id}" onclick="vote('${post.id}','loves', this)"><i>â¤ï¸</i><span class="count">${loves}</span></button>
              <button class="react-btn react-dislike" id="dislike-${post.id}" onclick="vote('${post.id}','dislikes', this)"><i>ğŸ‘</i><span class="count">${dislikes}</span></button>
              <button class="comments-toggle" id="toggle-${post.id}" onclick="toggleComments('${post.id}')">ğŸ’¬ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª <span class="badge-num">0</span></button>
              <button class="react-btn" onclick="sharePost()">ğŸ”— Ù…Ø´Ø§Ø±ÙƒØ©</button>
            </div>
            <div class="comments-panel" id="comments-wrap-${post.id}">
              <div style="margin-top:6px;"><strong>Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</strong></div>
              <div class="existing-comments" style="margin-top:6px;"></div>
              <div style="margin-top:8px;display:flex;gap:6px;">
                <input id="input-comment-${post.id}" class="input" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ..." style="flex:1;">
                <button class="btn" style="flex:0 0 auto;" onclick="submitComment('${post.id}')">Ø£Ø¶Ù</button>
              </div>
            </div>`;
          postsContainer.appendChild(card);

          observer.observe(card);

          if((i+1)%5===0){
            const wrapper=document.createElement('div'); wrapper.className='ad-slider-wrapper full-span';
            const slider=document.createElement('div'); slider.className='ad-slider';
            getRandomAds().forEach(ad=>{ const slide=document.createElement('div'); slide.className='ad-slide';
              slide.innerHTML=`<a href="${ad.link}" target="_blank" rel="noopener"><div class="ad-circle"><img src="${ad.image}" alt="${ad.name}" loading="lazy"></div><div class="ad-name">${ad.name}</div></a>`;
              slider.appendChild(slide);
            });
            const note=document.createElement('div'); note.className='ad-note'; note.innerHTML=`Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ù„Ø§Ù†Ùƒ Ø§Ù„Ø®Ø§Øµ <a href="https://wa.me/123456789" target="_blank" rel="noopener">Ø§Ø¶ØºØ· Ù‡Ù†Ø§</a>`;
            wrapper.appendChild(slider); wrapper.appendChild(note); postsContainer.appendChild(wrapper);
          }
        });

        document.querySelectorAll('.post').forEach(p=>{ const id=p.dataset.postId; if(id) initCommentsCount(id); });
        updateVisibility();
      }, err=>{
        console.error("load posts error",err);
        postsContainer.innerHTML=`<div class="error">ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.</div>`;
      });

      async function initCommentsCount(postId){
        try{
          const coll=collection(db,"posts",postId,"comments");
          const snap=await getCountFromServer(coll);
          const count=snap.data().count||0;
          const badge=document.querySelector(`#toggle-${postId} .badge-num`);
          if(badge) badge.textContent=count;
        }catch(e){console.warn("initCommentsCount error",e);}
      }

      window.toggleComments=function(postId){
        const panel=document.getElementById(`comments-wrap-${postId}`); if(!panel) return;
        const visible=panel.style.display==="block"; panel.style.display=visible?"none":"block"; if(visible) return;

        const container=panel.querySelector(".existing-comments");
        const q=query(collection(db,"posts",postId,"comments"),orderBy("createdAt","asc"));
        onSnapshot(q,snap=>{
          container.innerHTML=""; let count=0;
          snap.docs.forEach(d=>{ const c=d.data(); const div=document.createElement("div"); div.className="comment";
            const time=c.createdAt&&c.createdAt.toDate?timeAgo(c.createdAt.toDate()):""; div.innerHTML=`<div><strong>${escapeHtml(c.author||"Ù…Ø³ØªØ®Ø¯Ù…")}</strong> <small>${time}</small></div><div>${escapeHtml(c.text||"")}</div>`;
            container.appendChild(div); count++; });
          const badge=document.querySelector(`#toggle-${postId} .badge-num`); if(badge) badge.textContent=count;
        },e=>console.warn("comments error",e));
      };

      window.submitComment=async function(postId){
        const input=document.getElementById(`input-comment-${postId}`); if(!input) return;
        const text=input.value.trim(); if(!text) return;
        try{ await addDoc(collection(db,"posts",postId,"comments"),{text,author:"Ù…Ø³ØªØ®Ø¯Ù…",createdAt:serverTimestamp()}); input.value=""; }
        catch(e){ console.error("add comment error",e); window.showToast?.("ØªØ¹Ø°Ù‘Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§."); }
      };

      window.vote=async function(postId,field,btn){
        const v=JSON.parse(localStorage.getItem("votes")||"{}");
        if(v[postId]){window.showToast?.("Ù„Ù‚Ø¯ ØµÙˆÙ‘ØªÙ‘Ù Ù…Ø³Ø¨Ù‚Ù‹Ø§ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø´ÙˆØ±.");return;}
        try{ const span=btn.querySelector('.count'); span.textContent=(parseInt(span.textContent)||0)+1; btn.classList.add('active');
             document.getElementById(`love-${postId}`).disabled=true; document.getElementById(`dislike-${postId}`).disabled=true;
             await updateDoc(doc(db,"posts",postId),{[field]:increment(1)}); v[postId]=field; localStorage.setItem("votes",JSON.stringify(v)); }
        catch(e){ console.error("vote error",e); window.showToast?.("ØªØ¹Ø°Ù‘Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØµÙˆÙŠØªØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§."); }
      };

      window.submitPost = async function(){
        const type = document.getElementById("postType").value;
        const content = document.getElementById("postContent").value.trim();
        const imageURL = document.getElementById("imageURL").value.trim();
        const youtubeURL = document.getElementById("youtubeURL").value.trim();
        const facebookURL = document.getElementById("facebookURL").value.trim();
        const errorDiv = document.getElementById("postError");

        errorDiv.style.display="none";
        if(!type || !content){
          errorDiv.textContent = "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†Ø´ÙˆØ± ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰";
          errorDiv.style.display="block";
          return;
        }
        let media = { imageURL:null, youtubeURL:null, facebookURL:null };
        if(imageURL) media.imageURL = imageURL;
        else if(youtubeURL) media.youtubeURL = youtubeURL;
        else if(facebookURL) media.facebookURL = facebookURL;

        try{
          await addDoc(collection(db, "posts"), {
            type, content,
            imageURL: media.imageURL,
            youtubeURL: media.youtubeURL,
            facebookURL: media.facebookURL,
            loves:0, dislikes:0,
            timestamp: serverTimestamp()
          });
          closeNewPost();
          window.showToast?.("ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ± âœ…");
        }catch(e){
          console.error("submitPost error", e);
          errorDiv.textContent="ÙØ´Ù„ Ø§Ù„Ù†Ø´Ø±ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.";
          errorDiv.style.display="block";
        }
      };

      window.sharePost = function(){
        const text = "Ø£Ø¯Ø¹ÙˆÙƒ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ù„Ù‰ Ù…Ù†ØµØ© KeFo Posts Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø·: " + window.location.href;
        if(navigator.share) navigator.share({ text }).catch(()=>{});
        else navigator.clipboard.writeText(text).then(()=>showToast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!")).catch(()=>{});
      };

    } else {
      postsContainer.innerHTML=`<div class="error">ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</div>`;
    }

    function timeAgo(date){const diff=Math.floor((Date.now()-date.getTime())/1000);if(diff<60)return diff+" Ø«ÙˆØ§Ù†ÙŠ";if(diff<3600)return Math.floor(diff/60)+" Ø¯Ù‚Ø§Ø¦Ù‚";if(diff<86400)return Math.floor(diff/3600)+" Ø³Ø§Ø¹Ø§Øª";return Math.floor(diff/86400)+" Ø£ÙŠØ§Ù…";}
    function escapeHtml(str){return String(str).replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));}
  </script>
</body>
</html>
